<template>
  <div class="test-center">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
      <button class="back-btn" @click="goBack">
        <span class="arrow">â†</span>
      </button>
      <h1 class="page-title">æµ‹è¯•ä¸­å¿ƒ</h1>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="content">
      <!-- å¼€å‘ç¯å¢ƒæç¤º -->
      <div class="dev-notice">
        <div class="notice-icon">ğŸ§ª</div>
        <div class="notice-content">
          <h3>å¼€å‘æµ‹è¯•ç¯å¢ƒ</h3>
          <p>æ­¤é¡µé¢åŒ…å«æ‰€æœ‰å¼€å‘å’Œæµ‹è¯•åŠŸèƒ½ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨</p>
        </div>
      </div>

      <!-- æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• -->
      <div class="test-section">
        <h2 class="section-title">
          <span class="section-icon">ğŸ”§</span>
          æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
        </h2>
        
        <div class="test-grid">
          <div class="test-card" @click="goToZkpTest">
            <div class="card-icon">ğŸ”</div>
            <div class="card-content">
              <h3 class="card-title">é›¶çŸ¥è¯†è¯æ˜</h3>
              <p class="card-desc">æµ‹è¯•ZKPç”Ÿæˆå’ŒéªŒè¯åŠŸèƒ½</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToWallet">
            <div class="card-icon">ğŸ’°</div>
            <div class="card-content">
              <h3 class="card-title">é’±åŒ…ç®¡ç†</h3>
              <p class="card-desc">ä»¥å¤ªåŠé’±åŒ…åˆ›å»ºå’Œç®¡ç†</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToAccountAbstraction">
            <div class="card-icon">ğŸ—ï¸</div>
            <div class="card-content">
              <h3 class="card-title">è´¦æˆ·æŠ½è±¡</h3>
              <p class="card-desc">ERC-4337æ™ºèƒ½åˆçº¦è´¦æˆ·</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToWeeklySummary">
            <div class="card-icon">ğŸ“‹</div>
            <div class="card-content">
              <h3 class="card-title">å‘¨æ‰“å¡æ±‡æ€»</h3>
              <p class="card-desc">æµ‹è¯•å‘¨åº¦æ‰“å¡å’Œè¯æ˜ç”Ÿæˆ</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>
        </div>
      </div>

      <!-- è¿ç§»åŠŸèƒ½æµ‹è¯• -->
      <div class="test-section">
        <h2 class="section-title">
          <span class="section-icon">ğŸ“±</span>
          è¿ç§»åŠŸèƒ½æµ‹è¯•
        </h2>
        
        <div class="test-grid">
          <div class="test-card" @click="goToMigrationTest">
            <div class="card-icon">ğŸ§ª</div>
            <div class="card-content">
              <h3 class="card-title">è¿ç§»åŠŸèƒ½æµ‹è¯•</h3>
              <p class="card-desc">æµ‹è¯•è´¦æˆ·è¿ç§»çš„å„é¡¹åŠŸèƒ½</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToOldDeviceMigration">
            <div class="card-icon">ğŸ“¤</div>
            <div class="card-content">
              <h3 class="card-title">æ—§è®¾å¤‡è¿ç§»</h3>
              <p class="card-desc">æ¨¡æ‹Ÿæ—§è®¾å¤‡å‘èµ·è¿ç§»</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToNewDeviceImport">
            <div class="card-icon">ğŸ“¥</div>
            <div class="card-content">
              <h3 class="card-title">æ–°è®¾å¤‡å¯¼å…¥</h3>
              <p class="card-desc">æ¨¡æ‹Ÿæ–°è®¾å¤‡å¯¼å…¥è´¦æˆ·</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>
        </div>
      </div>

      <!-- ç”¨æˆ·æµç¨‹æµ‹è¯• -->
      <div class="test-section">
        <h2 class="section-title">
          <span class="section-icon">ğŸ‘¤</span>
          ç”¨æˆ·æµç¨‹æµ‹è¯•
        </h2>
        
        <div class="test-grid">
          <div class="test-card" @click="goToSplash">
            <div class="card-icon">ğŸ </div>
            <div class="card-content">
              <h3 class="card-title">æ¬¢è¿é¡µé¢</h3>
              <p class="card-desc">åº”ç”¨å¯åŠ¨å’Œç”¨æˆ·å¼•å¯¼</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToAccountChoice">
            <div class="card-icon">âš¡</div>
            <div class="card-content">
              <h3 class="card-title">è´¦æˆ·é€‰æ‹©</h3>
              <p class="card-desc">æ–°ç”¨æˆ·è´¦æˆ·ç±»å‹é€‰æ‹©</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToSignup">
            <div class="card-icon">âœ¨</div>
            <div class="card-content">
              <h3 class="card-title">ç”¨æˆ·æ³¨å†Œ</h3>
              <p class="card-desc">èº«ä»½éªŒè¯å’Œè´¦æˆ·åˆ›å»º</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>

          <div class="test-card" @click="goToRegistrationFlowTest">
            <div class="card-icon">ğŸ”„</div>
            <div class="card-content">
              <h3 class="card-title">æ³¨å†Œæµç¨‹æµ‹è¯•</h3>
              <p class="card-desc">å®Œæ•´æ³¨å†Œæµç¨‹çš„è‡ªåŠ¨åŒ–æµ‹è¯•</p>
            </div>
            <div class="card-arrow">â†’</div>
          </div>
        </div>
      </div>

      <!-- å·¥å…·å’ŒçŠ¶æ€ -->
      <div class="test-section">
        <h2 class="section-title">
          <span class="section-icon">ğŸ› ï¸</span>
          å¼€å‘å·¥å…·
        </h2>
        
        <div class="tools-grid">
          <div class="tool-card" @click="clearAllData">
            <div class="tool-icon">ğŸ—‘ï¸</div>
            <div class="tool-content">
              <h4 class="tool-title">æ¸…é™¤æ‰€æœ‰æ•°æ®</h4>
              <p class="tool-desc">é‡ç½®åº”ç”¨åˆ°åˆå§‹çŠ¶æ€</p>
            </div>
          </div>

          <div class="tool-card" @click="showCacheManager">
            <div class="tool-icon">ğŸ“¦</div>
            <div class="tool-content">
              <h4 class="tool-title">ç¼“å­˜ç®¡ç†</h4>
              <p class="tool-desc">ç»†ç²’åº¦æ¸…é™¤å„ç±»ç¼“å­˜</p>
            </div>
          </div>

          <div class="tool-card" @click="toggleRegistrationStatus">
            <div class="tool-icon">ğŸ”„</div>
            <div class="tool-content">
              <h4 class="tool-title">åˆ‡æ¢æ³¨å†ŒçŠ¶æ€</h4>
              <p class="tool-desc">æ¨¡æ‹Ÿå·²æ³¨å†Œ/æœªæ³¨å†ŒçŠ¶æ€</p>
            </div>
          </div>

          <div class="tool-card" @click="showSystemInfo">
            <div class="tool-icon">â„¹ï¸</div>
            <div class="tool-content">
              <h4 class="tool-title">ç³»ç»Ÿä¿¡æ¯</h4>
              <p class="tool-desc">æŸ¥çœ‹è®¾å¤‡å’Œåº”ç”¨ä¿¡æ¯</p>
            </div>
          </div>
        </div>
      </div>

      <!-- çŠ¶æ€ä¿¡æ¯ -->
      <div class="status-section">
        <h3 class="status-title">å½“å‰çŠ¶æ€</h3>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">æ³¨å†ŒçŠ¶æ€</span>
            <span class="status-value" :class="{ 'registered': isRegistered }">
              {{ isRegistered ? 'å·²æ³¨å†Œ' : 'æœªæ³¨å†Œ' }}
            </span>
          </div>
          <div class="status-item">
            <span class="status-label">å½“å‰è·¯ç”±</span>
            <span class="status-value">{{ currentRoute }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">è®¾å¤‡ID</span>
            <span class="status-value">{{ deviceId }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { aaService } from '@/service/accountAbstraction';
import { Preferences } from '@capacitor/preferences';
import { Device } from '@capacitor/device';
import { CLEAR_GROUPS, KEY_CATEGORIES } from '@/config/storage.config';

const router = useRouter();
const route = useRoute();

// å“åº”å¼æ•°æ®
const isRegistered = ref(false);
const deviceId = ref('');

const currentRoute = computed(() => route.path);

// è¿”å›ä¸Šä¸€é¡µ
const goBack = () => {
  router.back();
};

// æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
const goToZkpTest = () => {
  router.push('/dev');
};

const goToWallet = () => {
  router.push('/dev/wallet');
};

const goToAccountAbstraction = () => {
  router.push('/dev/aa');
};

const goToWeeklySummary = () => {
  router.push('/weekly-summary');
};

// è¿ç§»åŠŸèƒ½æµ‹è¯•
const goToMigrationTest = () => {
  router.push('/test-migration');
};

const goToOldDeviceMigration = () => {
  router.push('/account-migration');
};

const goToNewDeviceImport = () => {
  router.push('/import-account');
};

// ç”¨æˆ·æµç¨‹æµ‹è¯•
const goToSplash = () => {
  router.push('/splash');
};

const goToAccountChoice = () => {
  router.push('/account-choice');
};

const goToSignup = () => {
  router.push('/signup');
};

const goToRegistrationFlowTest = () => {
  router.push('/test-registration-flow');
};

// å¼€å‘å·¥å…·
const clearAllData = async () => {
  if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†é‡ç½®åº”ç”¨åˆ°åˆå§‹çŠ¶æ€ï¼Œä¸å¯æ¢å¤ï¼')) {
    return;
  }

  try {
    // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨
    await Preferences.clear();
    
    alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼Œåº”ç”¨å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
    
    // åˆ·æ–°çŠ¶æ€
    await checkStatus();
    
    // è·³è½¬åˆ°æ¬¢è¿é¡µé¢
    router.push('/splash');
  } catch (error) {
    console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
    alert('âŒ æ¸…é™¤æ•°æ®å¤±è´¥');
  }
};

const showCacheManager = async () => {
  const categories = Object.entries(CLEAR_GROUPS).map(([key, value]) => ({
    name: key,
    label: KEY_CATEGORIES[key as keyof typeof KEY_CATEGORIES] || key,
    count: value.length
  }));

  const categoryList = categories
    .map(cat => `${cat.name} (${cat.count}): ${cat.label}`)
    .join('\n');

  const selected = prompt(
    `é€‰æ‹©è¦æ¸…é™¤çš„ç¼“å­˜ç±»åˆ«ï¼š\n\n${categoryList}\n\nè¯·è¾“å…¥ç±»åˆ«åç§°ï¼ˆå¦‚ï¼šAUTH, WALLET, CHECKINç­‰ï¼‰æˆ– ALL æ¸…é™¤æ‰€æœ‰`,
    'CHECKIN'
  );

  if (!selected) return;

  try {
    if (selected.toUpperCase() === 'ALL') {
      await Preferences.clear();
      alert('âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜');
    } else {
      const groupKey = selected.toUpperCase() as keyof typeof CLEAR_GROUPS;
      const keysToRemove = CLEAR_GROUPS[groupKey];

      if (!keysToRemove) {
        alert('âŒ æ— æ•ˆçš„ç±»åˆ«åç§°');
        return;
      }

      for (const key of keysToRemove) {
        await Preferences.remove({ key });
      }

      alert(`âœ… å·²æ¸…é™¤ ${groupKey} ç±»åˆ«çš„ ${keysToRemove.length} ä¸ªç¼“å­˜é¡¹`);
    }

    await checkStatus();
  } catch (error) {
    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
    alert('âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥');
  }
};

const toggleRegistrationStatus = async () => {
  try {
    if (isRegistered.value) {
      // æ¸…é™¤æ³¨å†ŒçŠ¶æ€
      await Preferences.remove({ key: 'accountInfo' });
      await Preferences.remove({ key: 'userInfo' });
      await Preferences.remove({ key: 'biometric' });
      alert('âœ… å·²åˆ‡æ¢åˆ°æœªæ³¨å†ŒçŠ¶æ€');
    } else {
      // è®¾ç½®ä¸ºå·²æ³¨å†ŒçŠ¶æ€
      await Preferences.set({
        key: 'accountInfo',
        value: JSON.stringify({
          address: '0x1234567890abcdef',
          ownerAddress: '0xabcdef1234567890',
          isDeployed: true
        })
      });
      
      await Preferences.set({
        key: 'userInfo',
        value: JSON.stringify({
          username: 'æµ‹è¯•ç”¨æˆ·', // ä½¿ç”¨ UserInfo æ¥å£çš„å­—æ®µå
          phoneNumber: '13800138000'
        })
      });
      
      alert('âœ… å·²åˆ‡æ¢åˆ°å·²æ³¨å†ŒçŠ¶æ€');
    }
    
    await checkStatus();
  } catch (error) {
    console.error('åˆ‡æ¢æ³¨å†ŒçŠ¶æ€å¤±è´¥:', error);
    alert('âŒ åˆ‡æ¢çŠ¶æ€å¤±è´¥');
  }
};

const showSystemInfo = async () => {
  try {
    const deviceInfo = await Device.getInfo();
    const deviceIdInfo = await Device.getId();
    
    const info = `
è®¾å¤‡ä¿¡æ¯ï¼š
â€¢ å¹³å°: ${deviceInfo.platform}
â€¢ æ“ä½œç³»ç»Ÿ: ${deviceInfo.operatingSystem}
â€¢ ç‰ˆæœ¬: ${deviceInfo.osVersion}
â€¢ è®¾å¤‡ID: ${deviceIdInfo.identifier}
â€¢ åˆ¶é€ å•†: ${deviceInfo.manufacturer}
â€¢ å‹å·: ${deviceInfo.model}
â€¢ æ˜¯å¦è™šæ‹Ÿè®¾å¤‡: ${deviceInfo.isVirtual ? 'æ˜¯' : 'å¦'}

åº”ç”¨ä¿¡æ¯ï¼š
â€¢ å½“å‰è·¯ç”±: ${route.path}
â€¢ æ³¨å†ŒçŠ¶æ€: ${isRegistered.value ? 'å·²æ³¨å†Œ' : 'æœªæ³¨å†Œ'}
    `.trim();
    
    alert(info);
  } catch (error) {
    console.error('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
    alert('âŒ è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥');
  }
};

// æ£€æŸ¥çŠ¶æ€
const checkStatus = async () => {
  try {
    isRegistered.value = await aaService.isRegistered();
    const deviceInfo = await Device.getId();
    deviceId.value = deviceInfo.identifier.slice(0, 8) + '...';
  } catch (error) {
    console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
  }
};

// ç»„ä»¶æŒ‚è½½
onMounted(() => {
  checkStatus();
});
</script>

<style scoped>
.test-center {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  flex-direction: column;
}

/* é¡¶éƒ¨å¯¼èˆª */
.header {
  padding: 20px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.back-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  backdrop-filter: blur(10px);
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.05);
}

.arrow {
  color: white;
  font-size: 1.5rem;
  line-height: 1;
}

.page-title {
  color: white;
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
}

/* ä¸»è¦å†…å®¹ */
.content {
  flex: 1;
  background: white;
  border-radius: 24px 24px 0 0;
  padding: 24px;
  margin-top: auto;
  animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* å¼€å‘ç¯å¢ƒæç¤º */
.dev-notice {
  background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
  border-radius: 16px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.notice-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.notice-content h3 {
  margin: 0 0 4px 0;
  color: #2d3436;
  font-size: 1.1rem;
  font-weight: 600;
}

.notice-content p {
  margin: 0;
  color: #636e72;
  font-size: 0.9rem;
  line-height: 1.4;
}

/* æµ‹è¯•åŒºåŸŸ */
.test-section {
  margin-bottom: 32px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0 0 16px 0;
  color: #2d3436;
  font-size: 1.2rem;
  font-weight: 600;
}

.section-icon {
  font-size: 1.3rem;
}

/* æµ‹è¯•å¡ç‰‡ç½‘æ ¼ */
.test-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.test-card {
  background: white;
  border: 2px solid #f1f3f4;
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.test-card:hover {
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.card-icon {
  font-size: 1.8rem;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

.card-content {
  flex: 1;
}

.card-title {
  margin: 0 0 4px 0;
  color: #2d3436;
  font-size: 1rem;
  font-weight: 600;
}

.card-desc {
  margin: 0;
  color: #636e72;
  font-size: 0.85rem;
  line-height: 1.4;
}

.card-arrow {
  color: #667eea;
  font-size: 1.2rem;
  transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  flex-shrink: 0;
}

.test-card:hover .card-arrow {
  transform: translateX(4px);
}

/* å·¥å…·ç½‘æ ¼ */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 12px;
}

.tool-card {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  display: flex;
  align-items: center;
  gap: 12px;
}

.tool-card:hover {
  background: #e9ecef;
  transform: translateY(-1px);
}

.tool-icon {
  font-size: 1.5rem;
  width: 40px;
  height: 40px;
  background: white;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.tool-content {
  flex: 1;
}

.tool-title {
  margin: 0 0 2px 0;
  color: #495057;
  font-size: 0.9rem;
  font-weight: 600;
}

.tool-desc {
  margin: 0;
  color: #6c757d;
  font-size: 0.8rem;
}

/* çŠ¶æ€åŒºåŸŸ */
.status-section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-top: 24px;
}

.status-title {
  margin: 0 0 16px 0;
  color: #495057;
  font-size: 1rem;
  font-weight: 600;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.status-label {
  color: #6c757d;
  font-size: 0.85rem;
}

.status-value {
  color: #495057;
  font-size: 0.85rem;
  font-weight: 500;
  font-family: monospace;
}

.status-value.registered {
  color: #28a745;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
  .content {
    padding: 20px 16px;
  }
  
  .test-grid {
    grid-template-columns: 1fr;
  }
  
  .tools-grid {
    grid-template-columns: 1fr;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .test-card {
    padding: 16px;
  }
  
  .card-icon {
    width: 45px;
    height: 45px;
    font-size: 1.5rem;
  }
}
</style>
