# 智能合约设计（以 SocialRecoveryAccount 为核心基础单位）

本系统链上部分以“患者智能账户”为基础单位进行组织与扩展，即每个患者对应一个 `SocialRecoveryAccount` 合约账户。系统将与患者相关的关键链上能力（账户控制权、社交恢复配置、与服药监督相关的链上提交与审计入口等）统一收敛到该账户合约中，使其既是身份载体，也是业务承载单元。

围绕该基础单位，系统通过 `EntryPoint` 提供账户抽象执行框架，通过工厂合约完成可预测部署与批量创建，并通过 Paymaster 合约实现 gas 费用赞助，降低患者的使用门槛。同时，系统提供 zk‑SNARK 验证器合约，用于在不暴露明文隐私数据的前提下完成链上可验证。

---

## 1. 核心合约组成

本项目 `contracts/` 目录中，与系统核心链上流程直接相关的合约包括：

- `contracts/core/EntryPoint.sol`
- `contracts/SocialRecoveryAccount.sol`
- `contracts/SocialRecoveryAccountFactory.sol`
- `contracts/SimplePaymaster.sol`
- `contracts/ZKPVerify/weeklySummaryVerifier.sol`
- `contracts/ZKPVerify/medicalZKPVerifier.sol`

> 说明：本文档以“作用与交互”为主，不展开代码实现与函数细节。

---

## 2. EntryPoint：账户抽象执行枢纽

`EntryPoint` 是系统链上执行的统一入口，负责承接客户端/后端提交的用户操作并完成链上执行。其核心作用是将传统 EOA 的“单交易自验证、自付费”模式，升级为可复用的账户抽象执行框架，使得用户可以通过智能账户完成链上交互，并支持后续扩展代付、批量操作与统一审计。

在系统运行中，用户的关键链上动作（例如提交与服药监督相关的链上调用、触发账户内部执行等）都会以用户操作的形式进入 `EntryPoint`。`EntryPoint` 会驱动患者的 `SocialRecoveryAccount` 完成合法性校验，并在校验通过后执行相应操作；同时，它会统一完成 gas 成本结算与事件记录，为离链监听、审计与问题定位提供依据。

---

## 3. SocialRecoveryAccount：患者智能账户（核心基础单位）

`SocialRecoveryAccount` 是本系统最核心的合约单元，承担“患者链上身份 + 权限控制 + 社交恢复 + 业务承载”的综合职责。系统将其定义为患者在链上的唯一可信执行主体：与患者相关的关键链上操作需要由该账户发起或由该账户授权后执行，从而形成“患者可控、过程可追溯”的链上交互闭环。

在正常使用场景下，患者通过客户端完成签名授权，`SocialRecoveryAccount` 作为账户抽象的一部分配合 `EntryPoint` 完成验证，并由 `EntryPoint` 驱动执行链上动作。由于该账户与 `EntryPoint` 绑定并约束调用入口，能够减少绕过系统流程直接触发敏感逻辑的风险，从而提升整体安全性与可审计性。

在异常场景下，`SocialRecoveryAccount` 提供社交恢复机制，以解决医疗场景中高频出现的“设备丢失/密钥丢失导致账户不可用”问题。系统在账户初始化阶段设置守护者集合（通常为监护人/家庭成员）与恢复门限；当患者无法正常控制账户时，可由守护者发起并共同确认恢复请求，在满足门限后将账户控制权安全切换给新的拥有者。这一机制使系统更贴近真实用户能力边界，提升可用性与容错性。

从隐私保护角度看，`SocialRecoveryAccount` 作为基础单位强调：链上记录只用于形成可验证、可追溯的审计证据，敏感明文数据应尽量留在链下；当系统需要证明“满足某种服药规则”时，应结合 zk‑SNARK 证明机制以实现“可验证但不泄露”。

---

## 4. SocialRecoveryAccountFactory：账户创建与可预测部署

为支持大规模患者接入，系统采用 `SocialRecoveryAccountFactory` 作为账户创建入口。工厂合约主要用于：

- 将患者账户的部署与初始化流程标准化，减少重复实现与运维复杂度。
- 支持可预测地址（counterfactual address）能力，使系统在实际部署前即可推导账户地址，便于提前完成绑定、配置与交互准备。
- 避免重复部署，提升部署管理与资源利用效率。

通过工厂合约，系统可以稳定地为每位患者创建独立的智能账户，实现“以账户为单位的权限隔离与审计边界”。

---

## 5. Paymaster（SimplePaymaster）：gas 费用赞助与门槛降低

为降低普通用户（患者）使用区块链的门槛，系统引入 `Paymaster` 机制，用于在账户抽象交易中替用户垫付 gas 费用。工程实现中对应 `SimplePaymaster`，其定位是示例型赞助合约：当用户操作携带 paymaster 信息时，`EntryPoint` 会优先使用 Paymaster 在 `EntryPoint` 中的存款进行结算，从而实现“用户无需预先充值 ETH 也能完成关键链上操作”的体验。

在协同关系上：

- 当 `UserOperation` 选择 Paymaster 赞助时，`EntryPoint` 会先校验 Paymaster 是否同意担保，并检查其存款余额是否满足本次操作的预付需求。
- 操作执行完成后，`EntryPoint` 按实际 gas 成本从 Paymaster 存款中扣款，并完成结算。

引入 Paymaster 的意义主要体现在：

- 提升可用性：患者在首次使用或紧急恢复场景下，无需理解或准备链上燃料费。
- 支持机构补贴：医院/项目方可统一承担必要链上成本，推动系统落地。
- 预留策略空间：后续可扩展白名单、额度限制、按业务类型赞助等风控策略。

需要说明的是：当前 `SimplePaymaster` 更偏演示用途，默认对所有操作提供担保；实际部署通常需要叠加更严格的访问控制与风控策略，避免无差别赞助导致资金风险。

---

## 6. zk‑SNARK 验证器合约：隐私证明的链上可验证组件

系统提供 zk‑SNARK 验证器合约（如 `weeklySummaryVerifier`、`medicalZKPVerifier`），用于验证客户端生成的零知识证明。验证器合约本身不承载业务数据，其作用是提供“链上可验证”能力：在不获取患者明文数据的前提下验证证明是否成立，从而实现“只证明合规性/完成度，不泄露具体服药细节”。

在架构中，验证器合约属于可复用的密码学组件，可被 `SocialRecoveryAccount` 或其调用路径中的业务逻辑按需集成，用于支撑论文目标中的“隐私保护型可验证监督”。

---

## 7. 合约协同关系总结

系统以 `SocialRecoveryAccount` 为基础单位承载患者身份与业务状态；`EntryPoint` 作为统一执行入口，为账户抽象提供验证、执行与结算框架；`SocialRecoveryAccountFactory` 负责可预测、规模化创建患者账户；`SimplePaymaster` 提供 gas 赞助能力降低使用门槛；zk‑SNARK 验证器合约提供隐私证明在链上的可验证性支撑。通过上述协同设计，系统实现了“患者可控、链上可审计、隐私不外泄、密钥可恢复、使用门槛更低”的服药监督链上基础设施。
