<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ½è±¡è´¦æˆ·åœ°å€æµ‹è¯•å·¥å…·</title>
  <!-- ä½¿ç”¨å¤šä¸ªCDNå¤‡ç”¨æ–¹æ¡ˆ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" 
          onerror="loadBackupEthers()"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .config {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .test-section {
      margin-bottom: 30px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
    }

    .test-section h2 {
      color: #764ba2;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-section h3 {
      color: #555;
      margin: 15px 0 10px 0;
      font-size: 1em;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: block;
      margin: 20px auto;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .result {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .account-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin: 8px 0;
      border-left: 4px solid #667eea;
    }

    .success {
      color: #28a745;
      font-weight: bold;
    }

    .error {
      color: #dc3545;
      font-weight: bold;
    }

    .warning {
      color: #ffc107;
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.error {
      background: #f8d7da;
      color: #721c24;
    }

    .loading {
      text-align: center;
      color: #667eea;
      font-size: 14px;
      margin: 10px 0;
    }

    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .summary h2 {
      color: white;
      margin-bottom: 15px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    code {
      background: #f1f1f1;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª æŠ½è±¡è´¦æˆ·åœ°å€æµ‹è¯•å·¥å…·</h1>
    <p class="subtitle">éªŒè¯ä¸åŒEOAè´¦æˆ·æ˜¯å¦ç”Ÿæˆä¸åŒçš„æŠ½è±¡è´¦æˆ·åœ°å€</p>

    <div class="config">
      <strong>åç«¯API:</strong> <span id="apiUrl"></span>
    </div>

    <button id="runAllTests" disabled>â³ æ­£åœ¨åŠ è½½ä¾èµ–...</button>

    <div class="test-section" id="test1Section">
      <h2>ğŸ“‹ æµ‹è¯•1: ä¸åŒEOA + ç›¸åŒSalt(0)</h2>
      <p>é¢„æœŸï¼šåº”è¯¥ç”Ÿæˆ3ä¸ª<strong>ä¸åŒ</strong>çš„æŠ½è±¡è´¦æˆ·åœ°å€</p>
      <div id="test1Results"></div>
    </div>

    <div class="test-section" id="test2Section">
      <h2>ğŸ“‹ æµ‹è¯•2: ç›¸åŒEOA + ä¸åŒSalt</h2>
      <p>é¢„æœŸï¼šåº”è¯¥ç”Ÿæˆ3ä¸ª<strong>ä¸åŒ</strong>çš„æŠ½è±¡è´¦æˆ·åœ°å€</p>
      <div id="test2Results"></div>
    </div>

    <div class="test-section" id="test3Section">
      <h2>ğŸ“‹ æµ‹è¯•3: ä¸åŒEOA + åŠ¨æ€Salt (åŸºäºåœ°å€ç”Ÿæˆ)</h2>
      <p>é¢„æœŸï¼šåº”è¯¥ç”Ÿæˆ3ä¸ª<strong>ä¸åŒ</strong>çš„æŠ½è±¡è´¦æˆ·åœ°å€</p>
      <div id="test3Results"></div>
    </div>

    <div class="test-section" id="test4Section">
      <h2>ğŸ“‹ æµ‹è¯•4: å¹‚ç­‰æ€§æµ‹è¯•</h2>
      <p>é¢„æœŸï¼šç›¸åŒçš„Owner+Saltåº”è¯¥äº§ç”Ÿ<strong>ç›¸åŒ</strong>çš„åœ°å€</p>
      <div id="test4Results"></div>
    </div>

    <div class="summary" id="summary" style="display: none;">
      <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
      <div id="summaryContent"></div>
    </div>
  </div>

  <script>
    // å¤‡ç”¨CDNåŠ è½½å‡½æ•°
    let ethersLoadAttempts = 0;
    const backupCDNs = [
      'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
    ];

    function loadBackupEthers() {
      if (ethersLoadAttempts < backupCDNs.length) {
        console.log(`å°è¯•ä»å¤‡ç”¨CDNåŠ è½½ ethers.js (${ethersLoadAttempts + 1}/${backupCDNs.length})...`);
        const script = document.createElement('script');
        script.src = backupCDNs[ethersLoadAttempts];
        script.onerror = loadBackupEthers;
        script.onload = () => {
          console.log('âœ… ethers.js åŠ è½½æˆåŠŸï¼');
          checkEthersLoaded();
        };
        document.head.appendChild(script);
        ethersLoadAttempts++;
      } else {
        showLoadError();
      }
    }

    function showLoadError() {
      document.getElementById('runAllTests').disabled = true;
      document.getElementById('runAllTests').textContent = 'âŒ ethers.js åŠ è½½å¤±è´¥';
      document.body.innerHTML = `
        <div class="container">
          <h1 style="color: #dc3545;">âš ï¸ ä¾èµ–åŠ è½½å¤±è´¥</h1>
          <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3>æ— æ³•åŠ è½½ ethers.js åº“</h3>
            <p style="margin-top: 10px;">å¯èƒ½çš„åŸå› ï¼š</p>
            <ul style="margin: 10px 0 10px 20px;">
              <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
              <li>CDNæœåŠ¡ä¸å¯ç”¨</li>
              <li>é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®</li>
            </ul>
            <h4 style="margin-top: 20px;">è§£å†³æ–¹æ¡ˆï¼š</h4>
            <ol style="margin: 10px 0 10px 20px;">
              <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
              <li>ä½¿ç”¨ Node.js ç‰ˆæœ¬: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">node test-account-address.js</code></li>
              <li>æˆ–è€…æ‰‹åŠ¨ä¸‹è½½ ethers.js å¹¶æ”¾åœ¨æœ¬åœ°</li>
            </ol>
          </div>
        </div>
      `;
    }

    function checkEthersLoaded() {
      if (typeof ethers !== 'undefined') {
        console.log('âœ… ethers.js å·²å°±ç»ª');
        const button = document.getElementById('runAllTests');
        if (button) {
          button.disabled = false;
          button.textContent = 'ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•';
        }
      } else {
        setTimeout(checkEthersLoaded, 100);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
    window.addEventListener('load', () => {
      if (typeof ethers === 'undefined') {
        console.warn('âš ï¸ ethers.js æœªåŠ è½½ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
        loadBackupEthers();
      } else {
        console.log('âœ… ethers.js å·²å°±ç»ª');
        checkEthersLoaded();
      }
    });

    const BACKEND_IP = '192.168.0.186';
    const API_BASE_URL = `http://${BACKEND_IP}:4337/api`;

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('apiUrl').textContent = API_BASE_URL;
    });

    // è°ƒç”¨APIè·å–è´¦æˆ·åœ°å€
    async function getAccountAddress(owner, salt) {
      const url = `${API_BASE_URL}/paymaster/get-account-address?owner=${owner}&salt=${salt}`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.ok) {
          throw new Error('APIè°ƒç”¨å¤±è´¥');
        }
        
        return data.address;
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        return null;
      }
    }

    // ç”ŸæˆåŸºäºåœ°å€çš„å”¯ä¸€salt
    function generateSaltFromAddress(address) {
      const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(address));
      const salt = ethers.BigNumber.from(hash).mod(1000000);
      return salt.toNumber();
    }

    // æµ‹è¯•1: ä¸åŒEOA + ç›¸åŒSalt
    async function test1() {
      const container = document.getElementById('test1Results');
      container.innerHTML = '<div class="loading">â³ æ­£åœ¨æµ‹è¯•...</div>';

      const accounts = [];
      
      for (let i = 0; i < 3; i++) {
        const wallet = ethers.Wallet.createRandom();
        const owner = wallet.address;
        const salt = 0;
        const abstractAddress = await getAccountAddress(owner, salt);
        
        accounts.push({ owner, salt, abstractAddress });
        
        container.innerHTML += `
          <div class="account-item">
            <strong>è´¦æˆ·${i + 1}</strong><br>
            EOAåœ°å€: <code>${owner}</code><br>
            Saltå€¼: <code>${salt}</code><br>
            æŠ½è±¡è´¦æˆ·: <code>${abstractAddress}</code>
          </div>
        `;
      }

      const uniqueAddresses = new Set(accounts.map(a => a.abstractAddress));
      const passed = uniqueAddresses.size === 3;
      
      container.querySelector('.loading').remove();
      container.innerHTML += `
        <div class="result ${passed ? 'success' : 'error'}">
          ${passed ? 'âœ…' : 'âŒ'} ç”Ÿæˆäº† ${uniqueAddresses.size} ä¸ªä¸åŒçš„åœ°å€ (æœŸæœ›: 3)
          ${!passed ? '<br>âš ï¸ åç«¯APIå¯èƒ½åªä½¿ç”¨äº†saltï¼Œæ²¡æœ‰ä½¿ç”¨ownerå‚æ•°' : ''}
        </div>
      `;

      return passed;
    }

    // æµ‹è¯•2: ç›¸åŒEOA + ä¸åŒSalt
    async function test2() {
      const container = document.getElementById('test2Results');
      container.innerHTML = '<div class="loading">â³ æ­£åœ¨æµ‹è¯•...</div>';

      const wallet = ethers.Wallet.createRandom();
      const owner = wallet.address;
      
      container.innerHTML = `<div class="result">æµ‹è¯•EOA: <code>${owner}</code></div>`;

      const accounts = [];
      
      for (let i = 0; i < 3; i++) {
        const salt = i;
        const abstractAddress = await getAccountAddress(owner, salt);
        
        accounts.push({ owner, salt, abstractAddress });
        
        container.innerHTML += `
          <div class="account-item">
            Salt=${i}: <code>${abstractAddress}</code>
          </div>
        `;
      }

      const uniqueAddresses = new Set(accounts.map(a => a.abstractAddress));
      const passed = uniqueAddresses.size === 3;
      
      container.innerHTML += `
        <div class="result ${passed ? 'success' : 'error'}">
          ${passed ? 'âœ…' : 'âŒ'} ç”Ÿæˆäº† ${uniqueAddresses.size} ä¸ªä¸åŒçš„åœ°å€ (æœŸæœ›: 3)
        </div>
      `;

      return passed;
    }

    // æµ‹è¯•3: åŠ¨æ€Salt
    async function test3() {
      const container = document.getElementById('test3Results');
      container.innerHTML = '<div class="loading">â³ æ­£åœ¨æµ‹è¯•...</div>';

      const accounts = [];
      
      for (let i = 0; i < 3; i++) {
        const wallet = ethers.Wallet.createRandom();
        const owner = wallet.address;
        const salt = generateSaltFromAddress(owner);
        const abstractAddress = await getAccountAddress(owner, salt);
        
        accounts.push({ owner, salt, abstractAddress });
        
        container.innerHTML += `
          <div class="account-item">
            <strong>è´¦æˆ·${i + 1}</strong><br>
            EOAåœ°å€: <code>${owner}</code><br>
            åŠ¨æ€Salt: <code>${salt}</code> (åŸºäºEOAåœ°å€å“ˆå¸Œç”Ÿæˆ)<br>
            æŠ½è±¡è´¦æˆ·: <code>${abstractAddress}</code>
          </div>
        `;
      }

      const uniqueAddresses = new Set(accounts.map(a => a.abstractAddress));
      const passed = uniqueAddresses.size === 3;
      
      container.querySelector('.loading').remove();
      container.innerHTML += `
        <div class="result ${passed ? 'success' : 'error'}">
          ${passed ? 'âœ…' : 'âŒ'} ç”Ÿæˆäº† ${uniqueAddresses.size} ä¸ªä¸åŒçš„åœ°å€ (æœŸæœ›: 3)
        </div>
      `;

      return passed;
    }

    // æµ‹è¯•4: å¹‚ç­‰æ€§
    async function test4() {
      const container = document.getElementById('test4Results');
      container.innerHTML = '<div class="loading">â³ æ­£åœ¨æµ‹è¯•...</div>';

      const wallet = ethers.Wallet.createRandom();
      const owner = wallet.address;
      const salt = 12345;

      container.innerHTML = `
        <div class="result">
          EOAåœ°å€: <code>${owner}</code><br>
          Saltå€¼: <code>${salt}</code>
        </div>
      `;

      const address1 = await getAccountAddress(owner, salt);
      const address2 = await getAccountAddress(owner, salt);
      const address3 = await getAccountAddress(owner, salt);

      container.innerHTML += `
        <div class="account-item">
          ç¬¬1æ¬¡è°ƒç”¨: <code>${address1}</code><br>
          ç¬¬2æ¬¡è°ƒç”¨: <code>${address2}</code><br>
          ç¬¬3æ¬¡è°ƒç”¨: <code>${address3}</code>
        </div>
      `;

      const passed = address1 === address2 && address2 === address3;
      
      container.innerHTML += `
        <div class="result ${passed ? 'success' : 'error'}">
          ${passed ? 'âœ… å¹‚ç­‰æ€§æ­£å¸¸' : 'âŒ å¹‚ç­‰æ€§å¤±è´¥'}
        </div>
      `;

      return passed;
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function runAllTests() {
      // æ£€æŸ¥ ethers.js æ˜¯å¦å·²åŠ è½½
      if (typeof ethers === 'undefined') {
        alert('âŒ ethers.js åº“æœªåŠ è½½ï¼Œæ— æ³•è¿è¡Œæµ‹è¯•ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
        return;
      }

      const button = document.getElementById('runAllTests');
      button.disabled = true;
      button.textContent = 'â³ æµ‹è¯•è¿›è¡Œä¸­...';

      const results = {
        test1: await test1(),
        test2: await test2(),
        test3: await test3(),
        test4: await test4()
      };

      // æ˜¾ç¤ºæ€»ç»“
      const summary = document.getElementById('summary');
      const summaryContent = document.getElementById('summaryContent');
      
      summaryContent.innerHTML = `
        <div class="summary-item">
          <span>æµ‹è¯•1 (ä¸åŒEOA+ç›¸åŒSalt)</span>
          <span class="badge ${results.test1 ? 'success' : 'error'}">
            ${results.test1 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
          </span>
        </div>
        <div class="summary-item">
          <span>æµ‹è¯•2 (ç›¸åŒEOA+ä¸åŒSalt)</span>
          <span class="badge ${results.test2 ? 'success' : 'error'}">
            ${results.test2 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
          </span>
        </div>
        <div class="summary-item">
          <span>æµ‹è¯•3 (åŠ¨æ€Salt)</span>
          <span class="badge ${results.test3 ? 'success' : 'error'}">
            ${results.test3 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
          </span>
        </div>
        <div class="summary-item">
          <span>æµ‹è¯•4 (å¹‚ç­‰æ€§)</span>
          <span class="badge ${results.test4 ? 'success' : 'error'}">
            ${results.test4 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
          </span>
        </div>
      `;

      if (!results.test1) {
        summaryContent.innerHTML += `
          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <strong>ğŸ’¡ å»ºè®®ï¼š</strong><br>
            åç«¯APIä¼¼ä¹æ²¡æœ‰æ­£ç¡®ä½¿ç”¨ownerå‚æ•°æ¥è®¡ç®—åœ°å€ã€‚<br>
            è¯·æ£€æŸ¥SimpleAccountFactoryåˆçº¦çš„getAddresså‡½æ•°å®ç°ã€‚<br>
            åœ°å€åº”è¯¥åŸºäº: keccak256(abi.encodePacked(owner, salt))
          </div>
        `;
      } else {
        summaryContent.innerHTML += `
          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <strong>âœ… åç«¯APIå·¥ä½œæ­£å¸¸ï¼</strong><br>
            å»ºè®®åœ¨å‰ç«¯ä½¿ç”¨åŠ¨æ€saltï¼ˆåŸºäºEOAåœ°å€ï¼‰æ¥ç¡®ä¿æ¯ä¸ªEOAéƒ½æœ‰å”¯ä¸€çš„æŠ½è±¡è´¦æˆ·ã€‚
          </div>
        `;
      }

      summary.style.display = 'block';
      button.disabled = false;
      button.textContent = 'ğŸ”„ é‡æ–°è¿è¡Œæµ‹è¯•';
    }

    document.getElementById('runAllTests').addEventListener('click', runAllTests);
  </script>
</body>
</html>

