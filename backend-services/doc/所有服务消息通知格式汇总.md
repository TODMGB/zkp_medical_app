# 所有服务消息通知格式汇总

本文档汇总了整个系统中所有服务发送的消息队列通知格式。

## 目录
- [1. 通用消息格式](#1-通用消息格式)
- [2. ERC4337服务 (守护者管理与账户恢复)](#2-erc4337服务-守护者管理与账户恢复)
- [3. Medication服务 (用药管理)](#3-medication服务-用药管理)
- [4. Migration服务 (账户迁移)](#4-migration服务-账户迁移)
- [5. Relationship服务 (关系管理)](#5-relationship服务-关系管理)
- [6. Secure Exchange服务 (加密消息)](#6-secure-exchange服务-加密消息)
- [7. User服务 (用户管理)](#7-user服务-用户管理)

---

## 1. 通用消息格式

### 基本结构
所有通知消息遵循以下基本格式：

```json
{
  "recipient_address": "0x...",      // 接收方地址
  "title": "通知标题",                // 通知标题
  "body": "通知内容",                 // 通知正文
  "type": "notification_type",        // 通知类型
  "data": {                           // 具体数据
    // 根据不同类型有不同字段
  },
  "priority": "normal|high|urgent",   // 优先级
  "channels": ["push", "websocket"]   // 通知渠道
}
```

### 路由规则
- **路由键格式**: `notification.{priority}`
- **交换机类型**: topic
- **优先级映射**:
  - `urgent` → `high` (大部分服务)
  - `high` → 优先级值 10
  - `normal` → 优先级值 5
  - `low` → 优先级值 1

---

## 2. ERC4337服务 (守护者管理与账户恢复)

### 2.1 守护者已添加
**类型**: `guardian_added`

```json
{
  "recipient_address": "账户地址",
  "title": "守护者已添加",
  "body": "新守护者 0x1234... 已成功添加到您的账户",
  "type": "guardian_added",
  "data": {
    "account_address": "账户地址",
    "guardian_address": "守护者地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 2.2 恢复阈值已修改
**类型**: `threshold_changed`

```json
{
  "recipient_address": "账户地址",
  "title": "恢复阈值已修改",
  "body": "账户恢复阈值已从 2 修改为 3",
  "type": "threshold_changed",
  "data": {
    "account_address": "账户地址",
    "old_threshold": 2,
    "new_threshold": 3,
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 2.3 账户恢复已发起
**类型**: `recovery_initiated`

```json
{
  "recipient_address": "被恢复账户地址",
  "title": "⚠️ 账户恢复已发起",
  "body": "守护者 0x1234... 发起了账户恢复请求",
  "type": "recovery_initiated",
  "data": {
    "account_address": "账户地址",
    "guardian_address": "发起恢复的守护者地址",
    "new_owner_address": "新Owner地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "urgent",
  "channels": ["push", "websocket"]
}
```

### 2.4 账户恢复获得支持
**类型**: `recovery_supported`

```json
{
  "recipient_address": "账户地址",
  "title": "⚠️ 账户恢复获得新支持",
  "body": "守护者 0x1234... 支持了恢复请求 (2/3)",
  "type": "recovery_supported",
  "data": {
    "account_address": "账户地址",
    "guardian_address": "支持的守护者地址",
    "new_owner_address": "新Owner地址",
    "current_approvals": 2,
    "required_approvals": 3,
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 2.5 账户恢复已取消 (通知账户拥有者)
**类型**: `recovery_cancelled`

```json
{
  "recipient_address": "账户地址",
  "title": "账户恢复已取消",
  "body": "您的账户恢复请求已被取消",
  "type": "recovery_cancelled",
  "data": {
    "account_address": "账户地址",
    "cancelled_by": "取消者地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 2.6 账户恢复已取消 (通知守护者)
**类型**: `recovery_cancelled_guardian`

```json
{
  "recipient_address": "守护者地址",
  "title": "账户恢复已取消",
  "body": "账户 0x1234... 的恢复请求已被取消",
  "type": "recovery_cancelled_guardian",
  "data": {
    "account_address": "账户地址",
    "cancelled_by": "取消者地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 2.7 账户恢复成功 (通知新Owner)
**类型**: `recovery_completed`

```json
{
  "recipient_address": "新Owner地址",
  "title": "✅ 账户恢复成功",
  "body": "账户 0x1234... 已成功恢复到您的控制",
  "type": "recovery_completed",
  "data": {
    "account_address": "账户地址",
    "old_owner_address": "旧Owner地址",
    "new_owner_address": "新Owner地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "urgent",
  "channels": ["push", "websocket"]
}
```

### 2.8 账户恢复成功 (通知旧Owner)
**类型**: `recovery_completed_old_owner`

```json
{
  "recipient_address": "旧Owner地址",
  "title": "⚠️ 账户已被恢复",
  "body": "您的账户 0x1234... 已被恢复到新的Owner",
  "type": "recovery_completed_old_owner",
  "data": {
    "account_address": "账户地址",
    "old_owner_address": "旧Owner地址",
    "new_owner_address": "新Owner地址",
    "tx_hash": "交易哈希",
    "timestamp": 1234567890
  },
  "priority": "urgent",
  "channels": ["push", "websocket"]
}
```

---

## 3. Medication服务 (用药管理)

### 3.1 用药计划已创建
**类型**: `medication_plan_created`

```json
{
  "type": "medication_plan_created",
  "recipient": "患者地址",
  "data": {
    // 完整的用药计划数据
    "patient_address": "患者地址",
    "medication_name": "药品名称",
    "dosage": "剂量",
    "frequency": "频率",
    // ... 其他计划字段
  }
}
```

**注意**: Medication服务使用不同的消息格式，路由键为 `notification.medication_plan_created`

### 3.2 用药计划已更新
**类型**: `medication_plan_updated`

```json
{
  "type": "medication_plan_updated",
  "recipient": "患者地址",
  "data": {
    // 更新后的用药计划数据
    "patient_address": "患者地址",
    // ... 更新的字段
  }
}
```

**路由键**: `notification.medication_plan_updated`

### 3.3 用药计划已分享
**类型**: `medication_plan_shared`

```json
{
  "type": "medication_plan_shared",
  "recipient": "接收方地址",
  "data": {
    "recipient": "接收方地址",
    // ... 分享相关数据
  }
}
```

**路由键**: `notification.medication_plan_shared`

---

## 4. Migration服务 (账户迁移)

### 4.1 迁移会话已创建
**类型**: `migration_session_created`

```json
{
  "recipient_address": "用户地址",
  "title": "账户迁移会话已创建",
  "body": "您的确认码是: 123456",
  "type": "migration_session_created",
  "data": {
    "migration_id": "会话ID",
    "confirm_code": "123456",
    "expires_at": "过期时间戳"
  },
  "priority": "urgent",
  "channels": ["push", "websocket"]
}
```

### 4.2 迁移完成
**类型**: `migration_completed`

```json
{
  "recipient_address": "用户地址",
  "title": "账户迁移成功",
  "body": "您的账户已成功迁移到新设备",
  "type": "migration_completed",
  "data": {
    "migration_id": "迁移ID",
    "old_device_id": "旧设备ID",
    "new_device_id": "新设备ID",
    "completed_at": 1234567890
  },
  "priority": "urgent",
  "channels": ["push", "websocket"]
}
```

---

## 5. Relationship服务 (关系管理)

### 5.1 邀请已接受 (通知Owner)
**类型**: `relationship_invitation_accepted`

```json
{
  "recipient_address": "老人/Owner地址",
  "title": "新成员加入",
  "body": "有新成员加入了您的\"家庭成员\"访问组",
  "type": "relationship_invitation_accepted",
  "data": {
    "viewer_address": "Viewer地址",
    "access_group_id": "访问组ID",
    "access_group_name": "访问组名称",
    "access_group_type": "访问组类型"
  },
  "priority": "normal",
  "channels": ["push", "websocket"]
}
```

### 5.2 成功加入访问组 (通知Viewer)
**类型**: `relationship_joined_group`

```json
{
  "recipient_address": "Viewer地址",
  "title": "加入成功",
  "body": "您已成功加入访问组\"家庭成员\"",
  "type": "relationship_joined_group",
  "data": {
    "owner_address": "Owner地址",
    "access_group_id": "访问组ID",
    "access_group_name": "访问组名称",
    "access_group_type": "访问组类型"
  },
  "priority": "normal",
  "channels": ["push", "websocket"]
}
```

### 5.3 关系已暂停
**类型**: `relationship_suspended`

```json
{
  "recipient_address": "被暂停的Viewer地址",
  "title": "访问权限已暂停",
  "body": "您对\"家庭成员\"的访问权限已被暂停",
  "type": "relationship_suspended",
  "data": {
    "owner_address": "Owner地址",
    "access_group_id": "访问组ID",
    "access_group_name": "访问组名称",
    "reason": "suspended_by_owner"
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 5.4 关系已恢复
**类型**: `relationship_resumed`

```json
{
  "recipient_address": "被恢复的Viewer地址",
  "title": "访问权限已恢复",
  "body": "您对\"家庭成员\"的访问权限已恢复",
  "type": "relationship_resumed",
  "data": {
    "owner_address": "Owner地址",
    "access_group_id": "访问组ID",
    "access_group_name": "访问组名称"
  },
  "priority": "normal",
  "channels": ["push", "websocket"]
}
```

### 5.5 关系已撤销
**类型**: `relationship_revoked`

```json
{
  "recipient_address": "被撤销的Viewer地址",
  "title": "访问权限已撤销",
  "body": "您对\"家庭成员\"的访问权限已被撤销",
  "type": "relationship_revoked",
  "data": {
    "owner_address": "Owner地址",
    "access_group_id": "访问组ID",
    "access_group_name": "访问组名称",
    "reason": "revoked_by_owner"
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### 5.6 邀请已创建
**类型**: `invitation_created`

```json
{
  "recipient_address": "接收通知的地址",
  "title": "邀请已创建",
  "body": "您的\"家庭成员\"访问组邀请已创建",
  "type": "invitation_created",
  "data": {
    "token": "邀请令牌",
    "access_group_name": "访问组名称",
    "expires_at": "过期时间"
  },
  "priority": "normal",
  "channels": ["websocket"]
}
```

---

## 6. Secure Exchange服务 (加密消息)

### 6.1 新的加密消息
**类型**: `encrypted_message`

```json
{
  "recipient_address": "接收方地址",
  "title": "新的加密消息",
  "body": "来自 0x1234... 的加密消息",
  "type": "encrypted_message",
  "data": {
    "senderAddress": "发送方地址",
    // ... 其他消息数据
  },
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

---

## 7. User服务 (用户管理)

### 7.1 用户已创建
**类型**: 事件 (非通知)
**路由键**: `user.created`

```json
{
  // 完整的用户对象
  "address": "用户地址",
  "username": "用户名",
  // ... 其他用户字段
}
```

**注意**: 这是一个系统事件，不是用户通知，使用不同的路由键。

---

## 消息优先级说明

### 优先级级别
1. **urgent** (紧急)
   - 账户恢复相关操作
   - 账户迁移操作
   - 映射为 `high` 优先级（MQ优先级值 10）

2. **high** (高)
   - 守护者添加/修改
   - 权限变更（暂停/撤销）
   - 账户恢复进度更新
   - MQ优先级值: 10

3. **normal** (普通)
   - 关系邀请
   - 访问组加入成功
   - 权限恢复
   - MQ优先级值: 5

4. **low** (低)
   - 一般信息通知
   - MQ优先级值: 1

### 通知渠道
- **push**: 推送通知
- **websocket**: WebSocket实时通知

大部分通知同时使用两种渠道，确保用户能及时收到重要信息。

---

## 消息队列配置

### 交换机配置
- **名称**: 从各服务配置文件获取 (`config.mq.exchangeName`)
- **类型**: topic
- **持久化**: true

### 路由键规则
- **标准格式**: `notification.{priority}`
  - `notification.high`
  - `notification.normal`
  - `notification.low`

- **特殊格式** (Medication服务):
  - `notification.{type}`
  - `notification.medication_plan_created`
  - `notification.medication_plan_updated`
  - `notification.medication_plan_shared`

- **系统事件**:
  - `user.created` (User服务)

### 消息持久化
所有消息都标记为持久化 (`persistent: true`)，确保消息在RabbitMQ重启后不会丢失。

---

## 注意事项

1. **地址格式**: 所有地址字段都是以太坊地址格式 (0x...)
2. **时间戳**: 使用 `Date.now()` 生成，为毫秒级时间戳
3. **消息格式差异**: Medication服务使用的消息格式与其他服务略有不同（使用 `recipient` 而非 `recipient_address`）
4. **优先级映射**: `urgent` 会被映射为 `high` 以符合通知服务的优先级系统
5. **通知去重**: 通知服务应实现去重机制，避免重复通知
6. **失败重试**: 各服务的producer应实现失败重试逻辑

---

## 开发建议

### 新增消息类型时
1. 确定消息的优先级
2. 选择合适的通知渠道
3. 设计清晰的data结构
4. 添加必要的上下文信息（如timestamp）
5. 考虑多方通知场景（如账户恢复需要通知多个相关方）

### 消息设计原则
1. **一致性**: 尽量保持与现有消息格式一致
2. **完整性**: 包含足够的上下文信息
3. **可追溯性**: 包含timestamp和相关ID
4. **用户友好**: title和body要清晰易懂
5. **安全性**: 敏感信息适当脱敏（如地址截取）

---

**文档版本**: 1.0  
**最后更新**: 2025-11-05



