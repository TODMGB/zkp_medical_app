# è¿ç§»æœåŠ¡æ¶ˆæ¯é˜Ÿåˆ—é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜æè¿°
è¿ç§»åï¼ŒNotification Serviceæ²¡æœ‰æ¥æ”¶åˆ°Migration Serviceå‘é€çš„æ¶ˆæ¯ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡ä»£ç å®¡æŸ¥å‘ç°ä»¥ä¸‹å‡ ä¸ªå¯èƒ½çš„é—®é¢˜ç‚¹ï¼š

### 1. âš ï¸ Migration Serviceæœªä¸»åŠ¨åˆå§‹åŒ–MQè¿æ¥

**é—®é¢˜æ‰€åœ¨**ï¼š
```1:89:g:\biyesheji\Elder_Medical_ZKP_project\migration-service\server.js
// server.js - Migration Service
const express = require('express');
const config = require('./src/config');
const mainRouter = require('./src/routes');
const migrationService = require('./src/services/migration.service');

// å¼•å…¥ä¸­é—´ä»¶
const corsMiddleware = require('./src/middleware/cors.middleware');
const securityMiddleware = require('./src/middleware/security.middleware');
const requestLogger = require('./src/middleware/requestLogger.middleware');
const notFoundHandler = require('./src/middleware/notFoundHandler.middleware');
const errorHandler = require('./src/middleware/errorHandler.middleware');

const app = express();

// ... ä¸­é—´ä»¶é…ç½® ...

async function startServer() {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“è¡¨
    await migrationService.initializeDatabase();
    
    // å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡
    migrationService.startCleanupTask();
    
    // âŒ ç¼ºå°‘ï¼šMQè¿æ¥åˆå§‹åŒ–
    
    // å¯åŠ¨ExpressæœåŠ¡å™¨ç›‘å¬æŒ‡å®šç«¯å£
    app.listen(config.PORT, () => {
      console.log(`ğŸš€ Migration Service is running on http://localhost:${config.PORT}`);
    });
  } catch (error) {
    console.error('âŒ Failed to start migration server:', error);
    process.exit(1);
  }
}
```

**ç°è±¡**ï¼š
- Migration Serviceå¯åŠ¨æ—¶**ä¸ä¼š**ä¸»åŠ¨è¿æ¥RabbitMQ
- åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ `publishMigrationSessionCreated()` æˆ– `publishMigrationCompleted()` æ—¶æ‰å°è¯•è¿æ¥
- å¦‚æœæ­¤æ—¶RabbitMQæœªå°±ç»ªæˆ–è¿æ¥å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±ä¸”**åªæ˜¾ç¤ºä¸€æ¡é”™è¯¯æ—¥å¿—**

### 2. âœ… Notification Serviceæ­£ç¡®åˆå§‹åŒ–äº†æ¶ˆè´¹è€…

```87:99:g:\biyesheji\Elder_Medical_ZKP_project\notification-service\server.js
async function startServer() {
  try {
    console.log('[Server] ğŸš€ Starting Notification Service...');
    
    // 1. åˆå§‹åŒ–WebSocketæœåŠ¡å™¨
    initializeWebSocket(wss);
    
    // 2. å¯åŠ¨gRPCæœåŠ¡å™¨
    startGrpcServer();
    
    // 3. âœ… å¯åŠ¨MQæ¶ˆè´¹è€…ï¼ˆä¼ å…¥wsså®ä¾‹ï¼‰
    await startConsumers(wss);
    
    // 4. å¯åŠ¨HTTPæœåŠ¡å™¨
```

**å¯¹æ¯”**ï¼šNotification Serviceåœ¨å¯åŠ¨æ—¶å°±åˆå§‹åŒ–äº†MQæ¶ˆè´¹è€…ï¼Œå› æ­¤èƒ½æ­£å¸¸ç›‘å¬é˜Ÿåˆ—ã€‚

---

## æ•…éšœæ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥RabbitMQæ˜¯å¦è¿è¡Œ
```powershell
# æ£€æŸ¥RabbitMQæœåŠ¡çŠ¶æ€
Get-Service -Name RabbitMQ

# æˆ–è®¿é—®ç®¡ç†ç•Œé¢
# http://localhost:15672
# é»˜è®¤ç”¨æˆ·å/å¯†ç : guest/guest
```

### æ­¥éª¤2ï¼šæ£€æŸ¥Migration Serviceçš„MQè¿æ¥

**æŸ¥çœ‹Migration Serviceå¯åŠ¨æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼ä¿¡æ¯ï¼š
```
ğŸš€ Migration Service is running on http://localhost:3003
```

**ä½†æ˜¯æ²¡æœ‰**ï¼š
```
Connecting to RabbitMQ...
RabbitMQ connected and channel created.
```

è¿™è¯´æ˜æœåŠ¡å¯åŠ¨æ—¶æ²¡æœ‰å»ºç«‹MQè¿æ¥ã€‚

### æ­¥éª¤3ï¼šæ£€æŸ¥å‘é€æ¶ˆæ¯æ—¶çš„æ—¥å¿—

å½“æ‰§è¡Œè¿ç§»æ“ä½œæ—¶ï¼ŒæŸ¥çœ‹Migration Serviceæ—¥å¿—ï¼š

**æ­£å¸¸æƒ…å†µ**ï¼š
```
ğŸ“¨ [MQ] å·²å‘é€"è¿ç§»ä¼šè¯åˆ›å»º"é€šçŸ¥
```

**å¼‚å¸¸æƒ…å†µ**ï¼š
```
âŒ [MQ] å‘é€é€šçŸ¥å¤±è´¥ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰: Error: connect ECONNREFUSED
```

### æ­¥éª¤4ï¼šæ£€æŸ¥Notification Serviceçš„é˜Ÿåˆ—ç»‘å®š

**æŸ¥çœ‹Notification Serviceå¯åŠ¨æ—¥å¿—**ï¼š
```
[MQ Consumer] Queue "notification.high" is ready (HIGH priority)
[MQ Consumer] Queue "notification.normal" is ready (NORMAL priority)
[MQ Consumer] Queue "notification.low" is ready (LOW priority)
[MQ Consumer] âœ… All notification consumers started successfully
```

å¦‚æœæ²¡æœ‰è¿™äº›æ—¥å¿—ï¼Œè¯´æ˜æ¶ˆè´¹è€…æ²¡æœ‰æ­£å¸¸å¯åŠ¨ã€‚

### æ­¥éª¤5ï¼šæ£€æŸ¥äº¤æ¢æœºå’Œé˜Ÿåˆ—é…ç½®

è®¿é—® RabbitMQ ç®¡ç†ç•Œé¢ (http://localhost:15672)

**æ£€æŸ¥é¡¹**ï¼š
1. âœ… äº¤æ¢æœº `exchange.notifications` æ˜¯å¦å­˜åœ¨
2. âœ… é˜Ÿåˆ— `notification.high`ã€`notification.normal`ã€`notification.low` æ˜¯å¦å­˜åœ¨
3. âœ… é˜Ÿåˆ—æ˜¯å¦æ­£ç¡®ç»‘å®šåˆ°äº¤æ¢æœº
4. âœ… ç»‘å®šçš„è·¯ç”±é”®æ˜¯å¦åŒ…å« `notification.high`

**é¢„æœŸçš„ç»‘å®šå…³ç³»**ï¼š
```
äº¤æ¢æœº: exchange.notifications (type: topic)
  â”œâ”€ notification.high â”€â”€> notification.high (é˜Ÿåˆ—)
  â”œâ”€ notification.high.* â”€â”€> notification.high (é˜Ÿåˆ—)
  â”œâ”€ notification.normal â”€â”€> notification.normal (é˜Ÿåˆ—)
  â”œâ”€ notification.normal.* â”€â”€> notification.normal (é˜Ÿåˆ—)
  â”œâ”€ notification.low â”€â”€> notification.low (é˜Ÿåˆ—)
  â””â”€ notification.low.* â”€â”€> notification.low (é˜Ÿåˆ—)
```

### æ­¥éª¤6ï¼šæ£€æŸ¥æ¶ˆæ¯è·¯ç”±

Migration Serviceå‘é€çš„æ¶ˆæ¯ä½¿ç”¨çš„è·¯ç”±é”®ï¼š
```javascript
// priority: 'urgent' â†’ æ˜ å°„ä¸º 'high'
const routingKey = `notification.high`;
```

è¿™åº”è¯¥èƒ½åŒ¹é…åˆ° `notification.high` é˜Ÿåˆ—çš„ç»‘å®šè§„åˆ™ã€‚

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨Migration Serviceå¯åŠ¨æ—¶åˆå§‹åŒ–MQè¿æ¥ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `migration-service/server.js`ï¼š

```javascript
async function startServer() {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“è¡¨
    await migrationService.initializeDatabase();
    
    // âœ… æ–°å¢ï¼šåˆå§‹åŒ–MQè¿æ¥
    const { getChannel } = require('./src/mq/client');
    try {
      await getChannel();
      console.log('âœ… RabbitMQ connected successfully');
    } catch (mqError) {
      console.error('âŒ Warning: Failed to connect to RabbitMQ:', mqError.message);
      console.error('   Notifications will not be sent until RabbitMQ is available');
    }
    
    // å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡
    migrationService.startCleanupTask();
    
    // å¯åŠ¨ExpressæœåŠ¡å™¨ç›‘å¬æŒ‡å®šç«¯å£
    app.listen(config.PORT, () => {
      console.log(`ğŸš€ Migration Service is running on http://localhost:${config.PORT}`);
      console.log(`ğŸ“‹ Health check: http://localhost:${config.PORT}/health`);
      console.log(`ğŸ”„ Migration API: http://localhost:${config.PORT}/api/migration`);
    });
  } catch (error) {
    console.error('âŒ Failed to start migration server:', error);
    process.exit(1);
  }
}
```

### æ–¹æ¡ˆ2ï¼šå¢å¼ºMQå®¢æˆ·ç«¯çš„é”™è¯¯å¤„ç†

ä¿®æ”¹ `migration-service/src/mq/client.js`ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```javascript
async function getChannel() {
  if (channel) {
    return channel;
  }
  
  try {
    console.log('[MQ Client] ğŸ”„ Connecting to RabbitMQ:', config.mq.url);
    connection = await amqp.connect(config.mq.url);
    channel = await connection.createChannel();
    console.log('[MQ Client] âœ… RabbitMQ connected and channel created.');

    connection.on('error', (err) => {
      console.error('[MQ Client] âŒ RabbitMQ connection error:', err.message);
    });
    
    connection.on('close', () => {
      console.warn('[MQ Client] âš ï¸ RabbitMQ connection closed. Will reconnect on next use...');
      connection = null;
      channel = null;
    });

    return channel;
  } catch (error) {
    console.error('[MQ Client] âŒ Failed to connect to RabbitMQ:', error.message);
    console.error('[MQ Client] âŒ Make sure RabbitMQ is running at:', config.mq.url);
    throw error;
  }
}
```

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿ `migration-service/.env` ä¸­çš„MQé…ç½®æ­£ç¡®ï¼š

```env
# RabbitMQé…ç½®
MQ_URL=amqp://localhost
MQ_EXCHANGE_NAME=exchange.notifications
```

ç¡®ä¿ä¸ `notification-service/.env` ä½¿ç”¨ç›¸åŒçš„é…ç½®ã€‚

### æ–¹æ¡ˆ4ï¼šæ·»åŠ æ¶ˆæ¯å‘é€é‡è¯•æœºåˆ¶

ä¿®æ”¹ `migration-service/src/mq/producer.js`ï¼š

```javascript
async function publishNotification(notification, retries = 3) {
  let lastError;
  
  for (let i = 0; i < retries; i++) {
    try {
      const channel = await getChannel();
      await channel.assertExchange(EXCHANGE_NAME, 'topic', { durable: true });

      let priority = notification.priority || 'normal';
      if (priority === 'urgent') {
        priority = 'high';
      }
      
      const routingKey = `notification.${priority}`;
      const message = Buffer.from(JSON.stringify(notification));

      channel.publish(EXCHANGE_NAME, routingKey, message, {
        persistent: true,
        priority: priority === 'high' ? 10 : priority === 'low' ? 1 : 5
      });

      console.log(`[MQ Producer] âœ… Sent notification '${routingKey}' to ${notification.recipient_address}`);
      return; // æˆåŠŸå‘é€ï¼Œé€€å‡º
      
    } catch (error) {
      lastError = error;
      console.error(`[MQ Producer] âŒ Attempt ${i + 1}/${retries} failed:`, error.message);
      
      if (i < retries - 1) {
        // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
      }
    }
  }
  
  console.error('[MQ Producer] âŒ Failed to publish notification after retries:', lastError);
  throw lastError;
}
```

---

## éªŒè¯ä¿®å¤

### 1. é‡å¯æ‰€æœ‰æœåŠ¡
```powershell
# åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆCtrl+Cï¼‰

# ç¡®ä¿RabbitMQè¿è¡Œ
Get-Service -Name RabbitMQ

# å…ˆå¯åŠ¨ Notification Service
cd notification-service
npm start

# ç­‰å¾…çœ‹åˆ°
# [MQ Consumer] âœ… All notification consumers started successfully

# å†å¯åŠ¨ Migration Service
cd migration-service
npm start

# åº”è¯¥çœ‹åˆ°
# âœ… RabbitMQ connected successfully
```

### 2. æµ‹è¯•è¿ç§»æµç¨‹
```http
POST http://localhost:3003/api/migration/create-session
Content-Type: application/json

{
  "id": "test-migration-001",
  "oldDeviceId": "device-old-123",
  "confirmCode": "123456",
  "userAddress": "0x1234567890123456789012345678901234567890"
}
```

### 3. æ£€æŸ¥æ—¥å¿—è¾“å‡º

**Migration Serviceæ—¥å¿—**ï¼š
```
ğŸ“¨ [MQ] å·²å‘é€"è¿ç§»ä¼šè¯åˆ›å»º"é€šçŸ¥
[MQ Producer] âœ… Sent notification 'notification.high' to 0x1234...
```

**Notification Serviceæ—¥å¿—**ï¼š
```
[Notification Consumer] Processing notification: migration_session_created
[Notification Consumer] âœ… Notification saved: xxx-uuid-xxx
[Notification Consumer] âœ… Notification sent via WebSocket to 0x1234...
[Notification Consumer] âœ… Notification processed successfully: xxx-uuid-xxx
```

### 4. æ£€æŸ¥RabbitMQç®¡ç†ç•Œé¢

è®¿é—® http://localhost:15672/#/queues
- æŸ¥çœ‹ `notification.high` é˜Ÿåˆ—
- ç¡®è®¤æ¶ˆæ¯å·²è¢«æ¶ˆè´¹ï¼ˆReady = 0, Total = å·²å¤„ç†æ•°é‡ï¼‰

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆMigration Serviceä¸æŠ¥é”™ï¼Ÿ
**A**: å› ä¸ºä»£ç ä¸­ä½¿ç”¨äº† `try-catch` ä½†åªè®°å½•æ—¥å¿—ï¼š
```javascript
try {
  await mqProducer.publishMigrationSessionCreated(...);
  console.log('ğŸ“¨ [MQ] å·²å‘é€"è¿ç§»ä¼šè¯åˆ›å»º"é€šçŸ¥');
} catch (mqError) {
  console.error('âŒ [MQ] å‘é€é€šçŸ¥å¤±è´¥ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰:', mqError);
  // âš ï¸ è¿™é‡Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¸»æµç¨‹ç»§ç»­
}
```

### Q2: æ¶ˆæ¯ä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿ
**A**: RabbitMQæ¶ˆæ¯æ²¡æœ‰æŒä¹…åŒ–åˆ°æ•°æ®åº“å¤‡ä»½ã€‚å¦‚æœéœ€è¦ä¿è¯ä¸ä¸¢å¤±ï¼š
1. ä½¿ç”¨ `persistent: true`ï¼ˆå·²å®ç°ï¼‰
2. ä½¿ç”¨ç¡®è®¤æœºåˆ¶ï¼ˆpublisher confirmsï¼‰
3. åœ¨æ•°æ®åº“ä¸­è®°å½•å¾…å‘é€çš„é€šçŸ¥
4. å®ç°è¡¥å¿æœºåˆ¶

### Q3: å¦‚ä½•æŸ¥çœ‹æ˜¯å¦æœ‰æ¶ˆæ¯ç§¯å‹ï¼Ÿ
**A**: 
1. è®¿é—® RabbitMQç®¡ç†ç•Œé¢
2. æŸ¥çœ‹ Queues æ ‡ç­¾
3. æ£€æŸ¥ "Ready" åˆ—ï¼ˆç­‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯æ•°ï¼‰
4. æ£€æŸ¥ "Unacked" åˆ—ï¼ˆæ­£åœ¨å¤„ç†çš„æ¶ˆæ¯æ•°ï¼‰

### Q4: ä¸ºä»€ä¹ˆNotification Serviceèƒ½æ”¶åˆ°å…¶ä»–æœåŠ¡çš„æ¶ˆæ¯ï¼Ÿ
**A**: å…¶ä»–æœåŠ¡ï¼ˆå¦‚relationship-service, erc4337-serviceï¼‰å¯èƒ½ï¼š
1. å¯åŠ¨æ—¶ä¸»åŠ¨åˆå§‹åŒ–äº†MQè¿æ¥
2. è¿æ¥æˆåŠŸåæ‰å‘é€æ¶ˆæ¯
3. æˆ–è€…ä½¿ç”¨äº†æ›´å¥å£®çš„é”™è¯¯å¤„ç†

---

## é¢„é˜²æªæ–½

### 1. åœ¨æ‰€æœ‰ProduceræœåŠ¡å¯åŠ¨æ—¶é¢„è¿æ¥MQ
### 2. å®æ–½å¥åº·æ£€æŸ¥æœºåˆ¶
### 3. æ·»åŠ ç›‘æ§å‘Šè­¦
### 4. ä½¿ç”¨æ¶ˆæ¯æŒä¹…åŒ–å’Œç¡®è®¤æœºåˆ¶
### 5. è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶ç®¡ç†å·¥å…·ï¼ˆå¦‚Bull/Bee-Queueï¼‰

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ç«‹å³ä¿®å¤ï¼šåœ¨Migration Serviceå¯åŠ¨æ—¶åˆå§‹åŒ–MQè¿æ¥
2. âœ… å¢å¼ºæ—¥å¿—ï¼šæ·»åŠ æ›´è¯¦ç»†çš„MQè¿æ¥å’Œå‘é€æ—¥å¿—
3. âœ… æ·»åŠ é‡è¯•ï¼šå®ç°æ¶ˆæ¯å‘é€é‡è¯•æœºåˆ¶
4. âš ï¸ ç›‘æ§å‘Šè­¦ï¼šæ¥å…¥ç›‘æ§ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
5. ğŸ“ æ–‡æ¡£æ›´æ–°ï¼šæ›´æ–°éƒ¨ç½²æ–‡æ¡£ï¼Œè¯´æ˜MQä¾èµ–

**ç«‹å³æ‰§è¡Œæ–¹æ¡ˆ1å³å¯è§£å†³90%çš„é—®é¢˜ï¼**


