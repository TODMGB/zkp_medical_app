# æ¶ˆæ¯é˜Ÿåˆ—ä¿®å¤éªŒè¯æŒ‡å—

## ä¿®å¤å†…å®¹æ€»ç»“

å·²ä¸ºä»¥ä¸‹æœåŠ¡æ·»åŠ äº†RabbitMQè¿æ¥åˆå§‹åŒ–ï¼Œç¡®ä¿æœåŠ¡å¯åŠ¨æ—¶ä¸»åŠ¨è¿æ¥MQï¼š

### âœ… å·²ä¿®å¤çš„æœåŠ¡

1. **Migration Service** (`migration-service/server.js`)
2. **Relationship Service** (`relationship-service/server.js`)
3. **ERC4337 Service** (`erc4337-service/server.js`)
4. **Medication Service** (`medication-service/server.js`)
5. **Secure Exchange Service** (`secure-exchange-service/server.js`)

### âœ… å¢å¼ºçš„MQå®¢æˆ·ç«¯

- **Migration Service MQ Client** (`migration-service/src/mq/client.js`) - æ·»åŠ äº†è¯¦ç»†çš„è¿æ¥æ—¥å¿—

---

## éªŒè¯æ­¥éª¤

### æ­¥éª¤1: ç¡®ä¿RabbitMQè¿è¡Œ

```powershell
# æ£€æŸ¥RabbitMQæœåŠ¡
Get-Service -Name RabbitMQ

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
Start-Service -Name RabbitMQ

# è®¿é—®ç®¡ç†ç•Œé¢
# http://localhost:15672
# ç”¨æˆ·å/å¯†ç : guest/guest
```

### æ­¥éª¤2: é‡å¯æ‰€æœ‰æœåŠ¡

**æŒ‰é¡ºåºå¯åŠ¨ï¼š**

1. **å…ˆå¯åŠ¨Notification Service**ï¼ˆæ¶ˆè´¹è€…ï¼‰
```powershell
cd notification-service
npm start
```

**æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š**
```
[Server] ğŸš€ Starting Notification Service...
âœ… WebSocketæœåŠ¡å™¨å·²å¯åŠ¨
âœ… gRPCæœåŠ¡å™¨å·²å¯åŠ¨
[MQ Consumer] Queue "notification.high" is ready (HIGH priority)
[MQ Consumer] Queue "notification.normal" is ready (NORMAL priority)
[MQ Consumer] Queue "notification.low" is ready (LOW priority)
[MQ Consumer] âœ… All notification consumers started successfully
```

2. **å†å¯åŠ¨Migration Service**ï¼ˆç”Ÿäº§è€…ï¼‰
```powershell
cd migration-service
npm start
```

**æœŸæœ›çœ‹åˆ°çš„æ–°æ—¥å¿—ï¼š**
```
[MQ Client] ğŸ”„ Connecting to RabbitMQ: amqp://localhost
[MQ Client] âœ… RabbitMQ connected and channel created.
[MQ Client] ğŸ“¡ Using exchange: exchange.notifications
âœ… RabbitMQ connected successfully
ğŸš€ Migration Service is running on http://localhost:3003
```

3. **å¯åŠ¨å…¶ä»–æœåŠ¡**
```powershell
# Relationship Service
cd relationship-service
npm start
# åº”è¯¥çœ‹åˆ°: âœ… RabbitMQ connected successfully

# ERC4337 Service
cd erc4337-service
npm start
# åº”è¯¥çœ‹åˆ°: âœ… RabbitMQ connected successfully

# Medication Service
cd medication-service
npm start
# åº”è¯¥çœ‹åˆ°: âœ… RabbitMQ Producerå·²è¿æ¥

# Secure Exchange Service
cd secure-exchange-service
npm start
# åº”è¯¥çœ‹åˆ°: âœ… RabbitMQ Producerå·²è¿æ¥
```

### æ­¥éª¤3: æµ‹è¯•è¿ç§»æµç¨‹å¹¶éªŒè¯é€šçŸ¥

#### 3.1 åˆ›å»ºè¿ç§»ä¼šè¯

**æµ‹è¯•è¯·æ±‚ï¼š**
```http
POST http://localhost:3003/api/migration/create-session
Content-Type: application/json

{
  "id": "test-migration-20251105",
  "oldDeviceId": "device-old-abc123",
  "confirmCode": "123456",
  "userAddress": "0x1234567890123456789012345678901234567890"
}
```

**Migration Serviceæ—¥å¿—ï¼ˆåº”è¯¥çœ‹åˆ°ï¼‰ï¼š**
```
ğŸ”„ [Migration Controller] æ”¶åˆ°åˆ›å»ºè¿ç§»ä¼šè¯è¯·æ±‚
âœ… [Service] è¿ç§»æœåŠ¡è°ƒç”¨æˆåŠŸ
[MQ Producer] âœ… Sent notification 'notification.high' to 0x1234567890123456789012345678901234567890
ğŸ“¨ [MQ] å·²å‘é€"è¿ç§»ä¼šè¯åˆ›å»º"é€šçŸ¥
âœ… [Response] å“åº”å·²å‘é€
```

**Notification Serviceæ—¥å¿—ï¼ˆåº”è¯¥çœ‹åˆ°ï¼‰ï¼š**
```
[Notification Consumer] Processing notification: migration_session_created
[Notification Consumer] âœ… Notification saved: xxx-uuid-xxx
[Notification Consumer] âš ï¸ User 0x1234... is offline
[Notification Consumer] âœ… Notification processed successfully: xxx-uuid-xxx
```

#### 3.2 ç¡®è®¤è¿ç§»å®Œæˆ

**æµ‹è¯•è¯·æ±‚ï¼š**
```http
POST http://localhost:3003/api/migration/confirm
Content-Type: application/json

{
  "migrationId": "test-migration-20251105",
  "newDeviceId": "device-new-xyz789",
  "userAddress": "0x1234567890123456789012345678901234567890"
}
```

**Migration Serviceæ—¥å¿—ï¼š**
```
ğŸ”„ [Migration Controller] æ”¶åˆ°ç¡®è®¤è¿ç§»è¯·æ±‚
âœ… [Service] è¿ç§»ç¡®è®¤æˆåŠŸ
[MQ Producer] âœ… Sent notification 'notification.high' to 0x1234...
ğŸ“¨ [MQ] å·²å‘é€"è¿ç§»å®Œæˆ"é€šçŸ¥
âœ… [Response] å“åº”å·²å‘é€
```

**Notification Serviceæ—¥å¿—ï¼š**
```
[Notification Consumer] Processing notification: migration_completed
[Notification Consumer] âœ… Notification saved: xxx-uuid-xxx
[Notification Consumer] âœ… Notification processed successfully: xxx-uuid-xxx
```

### æ­¥éª¤4: æ£€æŸ¥RabbitMQç®¡ç†ç•Œé¢

è®¿é—® **http://localhost:15672**

#### æ£€æŸ¥äº¤æ¢æœº
1. ç‚¹å‡» **Exchanges** æ ‡ç­¾
2. æ‰¾åˆ° `exchange.notifications`
3. ç¡®è®¤ç±»å‹ä¸º `topic`

#### æ£€æŸ¥é˜Ÿåˆ—
1. ç‚¹å‡» **Queues** æ ‡ç­¾
2. åº”è¯¥çœ‹åˆ°ä»¥ä¸‹é˜Ÿåˆ—ï¼š
   - `notification.high`
   - `notification.normal`
   - `notification.low`
3. æ£€æŸ¥æ¯ä¸ªé˜Ÿåˆ—çš„ç»Ÿè®¡ï¼š
   - **Ready**: 0ï¼ˆæ— ç§¯å‹æ¶ˆæ¯ï¼‰
   - **Total**: 2+ï¼ˆå·²å¤„ç†çš„æ¶ˆæ¯æ•°ï¼‰
   - **æ¶ˆè´¹è€…æ•°**: 1

#### æ£€æŸ¥ç»‘å®šå…³ç³»
1. ç‚¹å‡» `exchange.notifications` äº¤æ¢æœº
2. æŸ¥çœ‹ **Bindings** éƒ¨åˆ†
3. ç¡®è®¤ä»¥ä¸‹ç»‘å®šå­˜åœ¨ï¼š
   ```
   notification.high â†’ notification.high (queue)
   notification.high.* â†’ notification.high (queue)
   notification.normal â†’ notification.normal (queue)
   notification.normal.* â†’ notification.normal (queue)
   notification.low â†’ notification.low (queue)
   notification.low.* â†’ notification.low (queue)
   ```

### æ­¥éª¤5: æŸ¥è¯¢é€šçŸ¥è®°å½•

**æŸ¥è¯¢é€šçŸ¥APIï¼š**
```http
GET http://localhost:3004/api/notifications
Authorization: Bearer YOUR_JWT_TOKEN
x-user-smart-account: 0x1234567890123456789012345678901234567890
```

**æœŸæœ›å“åº”ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "notification_id": "uuid-1",
      "type": "migration_completed",
      "title": "è´¦æˆ·è¿ç§»æˆåŠŸ",
      "body": "æ‚¨çš„è´¦æˆ·å·²æˆåŠŸè¿ç§»åˆ°æ–°è®¾å¤‡",
      "priority": "HIGH",
      "status": "SENT",
      "created_at": "2025-11-05T...",
      ...
    },
    {
      "notification_id": "uuid-2",
      "type": "migration_session_created",
      "title": "è´¦æˆ·è¿ç§»ä¼šè¯å·²åˆ›å»º",
      "body": "æ‚¨çš„ç¡®è®¤ç æ˜¯: 123456",
      "priority": "HIGH",
      "status": "SENT",
      "created_at": "2025-11-05T...",
      ...
    }
  ]
}
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: æœåŠ¡å¯åŠ¨æ—¶æŠ¥"Failed to connect to RabbitMQ"

**åŸå› **: RabbitMQæœªè¿è¡Œæˆ–é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
Get-Service -Name RabbitMQ

# å¯åŠ¨æœåŠ¡
Start-Service -Name RabbitMQ

# æ£€æŸ¥.envé…ç½®
# MQ_URL=amqp://localhost
# MQ_EXCHANGE_NAME=exchange.notifications
```

### Q2: çœ‹åˆ°"Warning: Failed to connect to RabbitMQ"ä½†æœåŠ¡ç»§ç»­è¿è¡Œ

**è¿™æ˜¯æ­£å¸¸çš„ï¼** ä¿®å¤åçš„ä»£ç ä½¿ç”¨äº†try-catchï¼Œå³ä½¿MQè¿æ¥å¤±è´¥ï¼ŒæœåŠ¡ä¹Ÿä¼šå¯åŠ¨ã€‚

**å½±å“**: 
- âœ… æœåŠ¡æ­£å¸¸è¿è¡Œ
- âŒ æ— æ³•å‘é€é€šçŸ¥
- ğŸ’¡ å¯åŠ¨RabbitMQåï¼ŒæœåŠ¡ä¼šåœ¨ä¸‹æ¬¡å‘é€æ¶ˆæ¯æ—¶é‡æ–°è¿æ¥

### Q3: Notification Serviceæ”¶ä¸åˆ°æ¶ˆæ¯

**æ£€æŸ¥æ¸…å•**:
1. âœ… Notification Serviceæ˜¯å¦å…ˆå¯åŠ¨ï¼Ÿ
2. âœ… æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸå¯åŠ¨ï¼Ÿï¼ˆçœ‹æ—¥å¿—ï¼‰
3. âœ… äº¤æ¢æœºåç§°æ˜¯å¦ä¸€è‡´ï¼Ÿ
   - Migration: `config.mq.exchangeName`
   - Notification: `config.mq.exchangeName`
4. âœ… è·¯ç”±é”®æ˜¯å¦åŒ¹é…ï¼Ÿ
   - Producerå‘é€: `notification.high`
   - Consumerç»‘å®š: `notification.high`

**è°ƒè¯•å‘½ä»¤**:
```powershell
# åœ¨RabbitMQç®¡ç†ç•Œé¢ä¸­æ‰‹åŠ¨å‘é€æµ‹è¯•æ¶ˆæ¯
# Exchanges â†’ exchange.notifications â†’ Publish message
# Routing key: notification.high
# Payload:
{
  "recipient_address": "0x1234567890123456789012345678901234567890",
  "title": "æµ‹è¯•é€šçŸ¥",
  "body": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "type": "test_notification",
  "priority": "high",
  "channels": ["push", "websocket"]
}
```

### Q4: æ¶ˆæ¯å‘é€æˆåŠŸä½†æ²¡å­˜å‚¨åˆ°æ•°æ®åº“

**æ£€æŸ¥**:
1. Notification Serviceçš„æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
2. æŸ¥çœ‹Notification Serviceæ—¥å¿—æ˜¯å¦æœ‰æ•°æ®åº“é”™è¯¯
3. æ£€æŸ¥é€šçŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼š
```sql
SELECT * FROM notifications 
WHERE recipient_address = '0x1234567890123456789012345678901234567890'
ORDER BY created_at DESC;
```

---

## æ€§èƒ½éªŒè¯

### æµ‹è¯•æ¶ˆæ¯ååé‡

```powershell
# æ‰¹é‡åˆ›å»ºè¿ç§»ä¼šè¯ï¼ˆæµ‹è¯•è„šæœ¬ï¼‰
for ($i=1; $i -le 100; $i++) {
    Invoke-RestMethod -Uri "http://localhost:3003/api/migration/create-session" `
        -Method POST `
        -ContentType "application/json" `
        -Body (@{
            id = "test-migration-$i"
            oldDeviceId = "device-old-$i"
            confirmCode = "12345$i"
            userAddress = "0x1234567890123456789012345678901234567890"
        } | ConvertTo-Json)
    
    Start-Sleep -Milliseconds 100
}
```

**éªŒè¯æŒ‡æ ‡**:
- âœ… Migration Service: 100æ¡æ¶ˆæ¯æˆåŠŸå‘é€
- âœ… Notification Service: 100æ¡é€šçŸ¥æˆåŠŸå¤„ç†
- âœ… RabbitMQ: é˜Ÿåˆ—ä¸­æ— ç§¯å‹ï¼ˆReady = 0ï¼‰
- âœ… æ•°æ®åº“: 100æ¡é€šçŸ¥è®°å½•

---

## æµ‹è¯•å…¶ä»–æœåŠ¡çš„é€šçŸ¥

### Relationship Service - é‚€è¯·æ¥å—é€šçŸ¥

```http
POST http://localhost:50054/api/relation/accept
Content-Type: application/json

{
  "token": "your-invitation-token",
  "viewerAddress": "0x9876543210987654321098765432109876543210"
}
```

**æœŸæœ›**: Notification Serviceæ”¶åˆ° `relationship_invitation_accepted` é€šçŸ¥

### ERC4337 Service - å®ˆæŠ¤è€…æ·»åŠ é€šçŸ¥

```http
POST http://localhost:3001/api/guardian/add
Content-Type: application/json

{
  "accountAddress": "0x1234567890123456789012345678901234567890",
  "guardianAddress": "0xabcdef1234567890abcdef1234567890abcdef12"
}
```

**æœŸæœ›**: Notification Serviceæ”¶åˆ° `guardian_added` é€šçŸ¥

---

## ç›‘æ§å»ºè®®

### 1. æ—¥å¿—ç›‘æ§
- æ‰€æœ‰æœåŠ¡çš„MQè¿æ¥æ—¥å¿—
- æ¶ˆæ¯å‘é€æˆåŠŸ/å¤±è´¥æ—¥å¿—
- Notification Serviceå¤„ç†æ—¥å¿—

### 2. RabbitMQç›‘æ§
- é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
- æ¶ˆè´¹é€Ÿç‡
- è¿æ¥æ•°

### 3. æ•°æ®åº“ç›‘æ§
- é€šçŸ¥è¡¨å¢é•¿é€Ÿç‡
- æŸ¥è¯¢æ€§èƒ½

---

## æˆåŠŸæ ‡å¿— âœ…

ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼š

1. âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨æ—¶æ˜¾ç¤º "RabbitMQ connected successfully"
2. âœ… Migration Serviceå‘é€æ¶ˆæ¯åæ˜¾ç¤º "Sent notification"
3. âœ… Notification Serviceæ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯
4. âœ… RabbitMQç®¡ç†ç•Œé¢æ˜¾ç¤ºæ¶ˆæ¯å·²è¢«æ¶ˆè´¹
5. âœ… æ•°æ®åº“ä¸­å­˜åœ¨é€šçŸ¥è®°å½•
6. âœ… ç”¨æˆ·å¯ä»¥é€šè¿‡APIæŸ¥è¯¢åˆ°é€šçŸ¥

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```bash
git checkout HEAD~1 migration-service/server.js
git checkout HEAD~1 migration-service/src/mq/client.js
git checkout HEAD~1 relationship-service/server.js
git checkout HEAD~1 erc4337-service/server.js
git checkout HEAD~1 medication-service/server.js
git checkout HEAD~1 secure-exchange-service/server.js
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-05  
**ä¿®å¤ç‰ˆæœ¬**: v1.0  
**é¢„è®¡å½±å“**: æ‰€æœ‰æœåŠ¡çš„æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½æ¢å¤æ­£å¸¸


