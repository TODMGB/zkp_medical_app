# 测试脚本使用指南

本目录包含端到端（E2E）测试脚本，用于验证系统的完整功能流程。

## 📁 文件结构

```
tests/
├── utils/
│   └── test-data-manager.js            # 测试数据管理工具
├── setup-test-users.js                  # 用户注册和设置脚本
├── e2e-relationship-flow.test.js        # 关系管理测试脚本
├── e2e-notification-flow.test.js        # 通知服务测试脚本
├── e2e-secure-exchange-flow.test.js     # 安全传输服务测试脚本
├── e2e-medication-flow.test.js          # 医药服务测试脚本（新增）
├── test-data.json                       # 持久化测试数据（自动生成，已被 .gitignore）
└── README.md                            # 本文档
```

## 🚀 快速开始

### 1️⃣ 首次运行：设置测试用户

在首次运行测试之前，需要先创建并注册测试用户：

```bash
node tests/setup-test-users.js
```

**该脚本会执行以下操作：**
- ✅ 清理数据库（user-service, relationship-service, migration-service）
- ✅ 创建三个角色的 EOA 钱包（老人、医生、家属）
- ✅ 预计算 Smart Account 地址
- ✅ 注册用户到数据库
- ✅ 部署 Smart Account 到区块链
- ✅ 用户登录获取 Token
- ✅ 初始化访问组
- ✅ **保存所有数据到 `test-data.json` 文件**

**⚠️ 重要提示：**
- `test-data.json` 包含用户私钥等敏感信息，**请勿提交到版本控制**
- 该文件已被 `.gitignore` 忽略，确保安全

### 2️⃣ 后续运行：执行完整测试

设置完成后，可以直接运行完整的 E2E 测试：

```bash
# 关系管理测试
node tests/e2e-relationship-flow.test.js

# 通知服务测试
node tests/e2e-notification-flow.test.js

# 安全传输服务测试
node tests/e2e-secure-exchange-flow.test.js

# 医药服务测试（新增）
node tests/e2e-medication-flow.test.js

# 获取我的关系列表测试（新增）
node tests/e2e-my-relationships.test.js
```

**这些脚本会：**
- ✅ 自动检测 `test-data.json` 文件
- ✅ 加载已注册的用户数据（包括私钥、地址、Token）
- ✅ 跳过用户设置步骤
- ✅ 直接执行对应服务的功能测试

### 3️⃣ 强制重新创建用户

如果需要清空数据库并重新创建用户：

```bash
node tests/e2e-relationship-flow.test.js --force-setup
```

**该模式会：**
- ⚠️ 清空所有数据库
- ⚠️ 创建新的用户账户
- ⚠️ 执行完整测试流程
- ✅ 不会保存新数据到 `test-data.json`（仍使用旧文件，除非先运行 `setup-test-users.js`）

## 📊 测试覆盖范围

### 1️⃣ 关系管理测试（e2e-relationship-flow.test.js）

**第一部分：关系管理测试**
- ✅ 创建自定义访问组
- ✅ 创建邀请令牌
- ✅ 接受邀请建立关系
- ✅ 查看访问组成员
- ✅ 暂停/恢复/撤销关系

**第二部分：社交恢复测试**
- ✅ 添加守护者（医生、家属）
- ✅ 设置恢复阈值
- ✅ 查询守护者列表
- ✅ 模拟丢失私钥
- ✅ 守护者发起恢复
- ✅ 守护者支持恢复（达到阈值）
- ✅ 验证恢复结果（Owner 更换）

**第三部分：账户迁移测试**
- ✅ 创建迁移会话
- ✅ 获取迁移会话信息
- ✅ 验证确认码
- ✅ 完成迁移
- ✅ 验证迁移状态

### 2️⃣ 通知服务测试（e2e-notification-flow.test.js）
- ✅ 用户登录获取 Token
- ✅ 建立 WebSocket 连接
- ✅ 测试 WebSocket 心跳
- ✅ 初始化 RabbitMQ 连接
- ✅ 通过 MQ 发送通知
- ✅ 验证 WebSocket 实时接收
- ✅ HTTP API 测试（列表、未读数量、标记已读、删除等）

### 3️⃣ 安全传输服务测试（e2e-secure-exchange-flow.test.js）
- ✅ 发送加密消息
- ✅ 接收加密消息
- ✅ 多层加密验证
- ✅ 消息状态管理
- ✅ 消息撤销功能

### 4️⃣ 医药服务测试（e2e-medication-flow.test.js）🆕

**第一部分：药物信息管理测试**
- ✅ 医生按名称搜索药物信息
- ✅ 医生按类别搜索药物信息
- ✅ 获取药物详细信息

**第二部分：用药计划管理测试**
- ✅ 医生为老人创建加密的用药计划（包含多种药物）
- ✅ 同时创建服药提醒（支持多个时间点）
- ✅ 验证计划数据已加密存储
- ✅ 验证通过安全传输服务发送加密计划
- ✅ 老人接收加密的计划消息
- ✅ 医生查询自己创建的计划列表
- ✅ 老人查询自己的计划列表
- ✅ 老人查询计划详情

**第三部分：计划更新和状态管理测试**
- ✅ 医生更新用药计划
- ✅ 更新后自动发送新的加密消息
- ✅ 暂停用药计划
- ✅ 恢复用药计划
- ✅ 终止用药计划

**第四部分：提醒功能和统计测试**
- ✅ 创建定时提醒测试计划
- ✅ 验证提醒调度器功能
- ✅ 获取医生的计划统计数据
- ✅ 获取患者的计划统计数据

**关键特性验证：**
- 🔐 端到端加密：计划数据使用患者公钥加密
- 🔒 零知识存储：服务器无法读取计划明文
- 📨 多层加密转发：通过安全传输服务二次加密
- ⏰ 定时提醒：基于 node-cron 的提醒调度
- 📊 数据完整性：SHA256 哈希校验

### 5️⃣ 获取我的关系列表测试（e2e-my-relationships.test.js）🆕

**测试场景：**
- ✅ 创建两个老人账户（老人1、老人2）
- ✅ 创建医生和家属账户
- ✅ 老人1创建"家人"访问组，邀请家属
- ✅ 老人2创建"主治医生"访问组，邀请医生
- ✅ 老人1也邀请医生到"家人"访问组
- ✅ 医生和家属接受邀请

**核心测试点：**
- ✅ **医生调用 GET /api/relation/relationships/my**
  - 应返回2条关系记录（可访问老人1和老人2）
  - 包含完整的访问组信息和权限配置
  - 显示加入时间和最后访问时间
  
- ✅ **家属调用 GET /api/relation/relationships/my**
  - 应返回1条关系记录（可照护老人1）
  - 包含访问组名称和权限详情
  
- ✅ **老人调用 GET /api/relation/relationships/my**
  - 应返回空列表（老人是owner，不是viewer）

**接口响应格式：**
```json
{
  "success": true,
  "data": [
    {
      "id": "relationship_uuid",
      "owner_address": "0x123...",           // 患者/老人地址
      "viewer_address": "0x456...",          // 当前用户地址
      "access_group_id": 123,
      "access_group_name": "家人",
      "group_type": "FAMILY_PRIMARY",
      "status": "active",
      "permissions": {
        "canView": true,
        "canViewMedication": true,
        "canViewAppointments": true
      },
      "permission_level": 1,
      "joined_at": "2025-10-31T08:30:00.000Z",
      "last_accessed_at": "2025-10-31T10:00:00.000Z"
    }
  ],
  "count": 1
}
```

**业务价值：**
- 👨‍⚕️ 医生可以查看自己可以访问的所有患者列表
- 👨‍👩‍👧 家属可以查看自己可以照护的所有老人
- 📋 作为"我的患者列表"或"我的家人列表"功能的数据源
- 🔐 只显示当前用户作为访问者的关系，确保权限隔离

## 🔧 工具函数

### test-data-manager.js

提供以下功能：

```javascript
const { 
  loadTestData,         // 加载测试数据
  saveTestData,         // 保存测试数据
  validateTestData,     // 验证数据完整性
  clearTestData,        // 清除测试数据文件
  testDataExists,       // 检查文件是否存在
  getTestDataPath       // 获取文件路径
} = require('./utils/test-data-manager');
```

## 📝 test-data.json 数据结构

```json
{
  "elder": {
    "role": "老人",
    "username": "王秀英",
    "eoaAddress": "0x...",
    "eoaPrivateKey": "0x...",
    "smartAccount": "0x...",
    "salt": 123456,
    "token": "eyJhbGci...",
    "accessGroups": [...]
  },
  "doctor": {
    "role": "医生",
    "username": "李建国",
    "eoaAddress": "0x...",
    "eoaPrivateKey": "0x...",
    "smartAccount": "0x...",
    "salt": 654321,
    "token": "eyJhbGci..."
  },
  "family": {
    "role": "家属",
    "username": "张敏",
    "eoaAddress": "0x...",
    "eoaPrivateKey": "0x...",
    "smartAccount": "0x...",
    "salt": 789012,
    "token": "eyJhbGci..."
  },
  "metadata": {
    "createdAt": "2025-10-28T10:30:00.000Z",
    "apiBaseUrl": "http://localhost:3000"
  }
}
```

## 🛠️ 环境要求

在运行测试之前，请确保以下服务已启动：

1. **PostgreSQL 数据库** (端口 5400)
   - `bs_user_service_db`
   - `bs_relationship_db`
   - `migration_db`
   - `medication_service_db` 🆕
   - `secure_exchange_db` 🆕
   - `notification_db` 🆕

2. **Redis** (端口 6379)

3. **RabbitMQ** (端口 5672) 🆕
   - 用于消息队列和通知服务

4. **微服务**
   - `user-service` (gRPC :50051)
   - `relationship-service` (gRPC :50053)
   - `erc4337-service` (HTTP :4337)
   - `migration-service` (HTTP :3004)
   - `medication-service` (HTTP :3002, gRPC :50055) 🆕
   - `secure-exchange-service` (HTTP :3005, gRPC :50052) 🆕
   - `notification-service` (HTTP :3003, gRPC :50054) 🆕
   - `api-gateway` (HTTP :3000)

## 📈 测试输出示例

```
╔════════════════════════════════════════════════════╗
║       🚀 开始端到端测试：完整流程                   ║
╚════════════════════════════════════════════════════╝

✅ 从持久化文件加载测试数据
✅ [老人] 已加载 - EOA: 0x1234567...
✅ [医生] 已加载 - EOA: 0xabcdef0...
✅ [家属] 已加载 - EOA: 0x9876543...
ℹ️  数据创建时间: 2025-10-28T10:30:00.000Z
✅ 跳过用户设置步骤（步骤0-6），直接开始关系管理测试

📋 第一部分：关系管理测试
============================================================
✅ [老人] 创建访问组成功: 我的护理团队 (ID: 123)
✅ [医生邀请] Token: abc123...
...

🔐 第二部分：社交恢复测试
============================================================
✅ [医生] 已添加为守护者，交易: 0x...
...

🔄 第三部分：账户迁移测试
============================================================
✅ 迁移会话创建成功
...

╔════════════════════════════════════════════════════╗
║       🎉 测试完成！所有步骤执行成功                 ║
╚════════════════════════════════════════════════════╝
⏱️  总耗时: 45.32 秒
📦 数据模式: 使用持久化数据

📊 测试数据总结:
【关系管理】
   - 创建账户数: 3 (老人、医生、家属)
   - 访问组数: 6
   - 邀请数: 2
   - 关系数: 1

【社交恢复】
   - 守护者数: 2
   - 恢复阈值: 2
   - 原 Owner: 0x...
   - 新 Owner: 0x...

【账户迁移】
   - 迁移会话ID: mig_123456_test
   - 旧设备ID: device_old_001
   - 新设备ID: device_new_002
   - 确认码: 123456

✅ 所有功能验证通过！
```

## 🔒 安全提示

1. **私钥保护**
   - `test-data.json` 包含测试账户的私钥
   - 该文件仅用于本地测试环境
   - **绝对不要将该文件提交到 Git 仓库**
   - **不要在生产环境使用这些测试账户**

2. **数据库隔离**
   - 测试会清空指定数据库
   - 确保使用独立的测试数据库
   - 不要在生产数据库上运行测试

3. **Token 过期**
   - 保存的 Token 可能会过期
   - 如果测试因认证失败，请重新运行 `setup-test-users.js`

## 📞 故障排查

### 问题 1: "未找到有效的测试用户数据"

**解决方案：**
```bash
node tests/setup-test-users.js
```

### 问题 2: "Token 验证失败"

**原因：** Token 已过期

**解决方案：**
```bash
# 重新设置用户（会生成新的 Token）
node tests/setup-test-users.js
```

### 问题 3: "数据库连接失败"

**检查清单：**
- ✅ PostgreSQL 是否在运行？
- ✅ 数据库端口是否正确（默认 5400）？
- ✅ 数据库凭据是否正确？

### 问题 4: "服务不可用"

**检查清单：**
- ✅ 所有微服务是否已启动？
- ✅ 端口是否被占用？
- ✅ 服务日志是否有报错？

## 🎯 最佳实践

1. **首次设置**
   ```bash
   # 1. 启动所有服务
   # 2. 创建测试用户
   node tests/setup-test-users.js
   # 3. 验证 test-data.json 已生成
   ```

2. **日常开发**
   ```bash
   # 直接运行测试（使用已有用户）
   node tests/e2e-relationship-flow.test.js
   ```

3. **重大变更后**
   ```bash
   # 强制重新创建用户
   node tests/setup-test-users.js
   ```

4. **定期清理**
   ```bash
   # 删除测试数据文件
   rm tests/test-data.json
   # 重新设置
   node tests/setup-test-users.js
   ```

## 📈 医药服务测试输出示例

```
╔═══════════════════════════════════════════════════════════════════╗
║       🏥 医药服务端到端测试 - 完整流程验证                        ║
╚═══════════════════════════════════════════════════════════════════╝

测试开始时间: 2025-10-30 10:30:00
API地址: http://localhost:3000

==================================================================
📍 步骤 0: 加载测试用户数据
==================================================================
✅ [步骤 0] 老人账户: 王秀英 (0x1234567...)
✅ [步骤 0] 医生账户: 李建国 (0xabcdef0...)
✅ [步骤 0] 家属账户: 张敏 (0x9876543...)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔷 第一部分：药物信息管理测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

==================================================================
📍 步骤 1: 医生搜索药物信息
==================================================================
ℹ️  1.1 按名称搜索药物...
✅ [步骤 1.1] 找到 5 个匹配的药物
ℹ️    - 阿司匹林肠溶片 (阿司匹林)
✅ [步骤 1] 药物搜索测试完成，共找到 3 个可用药物

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔷 第二部分：用药计划管理测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

==================================================================
📍 步骤 2: 医生为老人创建加密的用药计划（包含提醒）
==================================================================
ℹ️  发送创建用药计划请求...
ℹ️    患者: 王秀英
ℹ️    计划名称: 高血压综合治疗方案
ℹ️    药物数量: 2
ℹ️    提醒数量: 3
✅ [步骤 2] 用药计划创建成功！
ℹ️    计划ID: 550e8400-e29b-41d4-a716-446655440000
ℹ️    加密状态: ❌ 已加密（不可读）
ℹ️    计划哈希: a1b2c3d4e5f6g7h8...
✅ [步骤 2] 已创建 3 个服药提醒
✅ [步骤 2] 已通过安全传输服务发送加密计划
ℹ️    消息ID: msg_abc123...

==================================================================
📍 步骤 3: 老人接收加密的计划消息
==================================================================
✅ [步骤 3] 老人收到 1 条加密消息
ℹ️    消息ID: msg_abc123...
ℹ️    发送者: 0xabcdef0...
ℹ️    数据类型: medication_plan
ℹ️    加密数据长度: 2048 字节
✅ [步骤 3] ✅ 加密消息接收验证通过！

═══════════════════════════════════════════════════════════════════
📊 测试结果总结
═══════════════════════════════════════════════════════════════════

总测试步骤: 10
通过步骤: 10
失败步骤: 0
成功率: 100.0%
总耗时: 15.32 秒

详细结果:
✅ 步骤 0: 加载测试用户数据
✅ 步骤 1: 医生搜索药物信息
✅ 步骤 2: 医生创建加密用药计划
✅ 步骤 3: 老人接收加密计划消息
✅ 步骤 4: 医生查询自己创建的计划
✅ 步骤 5: 老人查询自己的计划
✅ 步骤 6: 老人查询计划详情
✅ 步骤 7: 医生更新用药计划
✅ 步骤 8: 测试计划状态管理
✅ 步骤 9: 创建提醒测试计划

测试数据统计:
  创建的用药计划: 2
  搜索的药物: 3
  加密消息: 2

🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉
🎉 所有测试通过！医药服务功能验证成功！
🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉
```

## 📚 扩展阅读

- [API Gateway 文档](../README.md)
- [关系管理服务文档](../../relationship-service/README.md)
- [ERC4337 服务文档](../../erc4337-service/README.md)
- [账户迁移服务文档](../../migration-service/README.md)
- [医药服务文档](../../medication-service/README.md) 🆕
- [安全传输服务文档](../../secure-exchange-service/README.md) 🆕
- [通知服务文档](../../notification-service/README.md) 🆕

---

**Happy Testing! 🎉**

