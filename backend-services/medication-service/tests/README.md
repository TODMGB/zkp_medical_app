# 医药服务测试套件

## 📋 测试概述

本测试套件包含对医药服务所有核心功能的自动化测试。

### 测试覆盖范围

1. **健康检查** - 验证服务是否正常运行
2. **常用药物库** - 药物搜索、分类查询
3. **用药计划管理** - CRUD 操作
4. **计划分享控制** - 隐私保护功能
5. **权限验证** - 访问控制测试

## 🚀 快速开始

### 前提条件

1. 确保医药服务正在运行：
```bash
npm start
```

2. 服务应运行在 `http://localhost:3007`

### 运行所有测试

```bash
npm test
```

### 运行单个测试

```bash
# 健康检查测试
npm run test:health

# API 功能测试
npm test

# 运行所有测试
npm run test:all
```

## 📝 测试用例详情

### 1. 健康检查测试 (test-health.js)

**测试内容**：
- ✅ 服务是否响应
- ✅ 返回正确的服务信息
- ✅ 状态码为 200

**运行**：
```bash
npm run test:health
```

**预期输出**：
```
🏥 医药服务健康检查测试
✅ 服务运行正常
→ 服务名称: medication-service
→ 版本: 1.0.0
→ 状态: UP
```

### 2. API 功能测试 (test-medication-api.js)

#### 测试 1-3: 常用药物库

- **测试 1**: 获取药物分类列表
  - 验证返回 15 个分类
  - 每个分类包含药物数量

- **测试 2**: 搜索常用药物（按名称）
  - 搜索"氨氯地平"
  - 验证返回药物信息完整

- **测试 3**: 按分类搜索药物
  - 搜索"心血管系统用药"
  - 验证返回正确分类的药物

#### 测试 4-8: 用药计划管理

- **测试 4**: 创建用药计划
  - 医生创建计划
  - 包含 2 种药物
  - 保存计划ID供后续测试使用

- **测试 5**: 查询计划详情
  - 使用患者地址查询
  - 验证计划信息完整

- **测试 6**: 查询患者的所有计划
  - 验证返回计划列表
  - 检查计划数量

- **测试 7**: 查询医生创建的计划
  - 使用医生地址查询
  - 验证权限控制

- **测试 8**: 更新用药计划
  - 修改计划名称和备注
  - 验证更新成功

#### 测试 9-11: 计划分享控制（隐私保护）

- **测试 9**: 分享计划到群组
  - **关键**: 只有患者本人可以分享
  - 选择要分享的群组
  - 验证分享权限由患者控制

- **测试 10**: 查询分享状态
  - 查看计划分享给了谁
  - 验证分享记录

- **测试 11**: 撤销分享
  - **关键**: 患者可以随时撤销
  - 验证撤销功能正常

#### 测试 12: 权限验证

- **测试 12**: 未授权访问测试
  - 使用未授权用户尝试访问
  - 验证返回 403 错误
  - 确认隐私保护正常工作

#### 测试 13: 数据清理

- **测试 13**: 删除测试数据
  - 清理测试创建的计划
  - 保持数据库整洁

## 🎯 测试结果示例

```
🧪 医药服务 API 测试套件
API Base URL: http://localhost:3007
============================================================

📋 测试 1: 获取药物分类列表
   ✅ 获取成功
   → 分类数量: 15
   → 第一个分类: 心血管系统用药 (25种药物)

📋 测试 2: 搜索常用药物（按名称）
   ✅ 搜索成功
   → 找到 1 种药物
   → 药物: 氨氯地平片
   → 剂量: 5mg, 频率: 每日1次

... (更多测试输出)

🎉 所有测试通过！
============================================================
测试摘要:
  ✅ 常用药物库: 3个测试
  ✅ 用药计划管理: 5个测试
  ✅ 计划分享控制: 3个测试
  ✅ 权限验证: 1个测试
  ✅ 数据清理: 1个测试
  总计: 13个测试全部通过 ✓
============================================================
```

## 🔧 自定义配置

### 修改服务 URL

```bash
BASE_URL=http://localhost:3007 npm test
```

### 修改测试数据

编辑 `tests/test-medication-api.js` 中的 `testData` 对象：

```javascript
const testData = {
  doctor_address: '你的医生地址',
  patient_address: '你的患者地址',
  recipient_address: '你的接收者地址',
  // ...
};
```

## 📊 测试统计

- **总测试数**: 13 个
- **覆盖功能**: 5 大模块
- **平均运行时间**: ~3-5 秒
- **成功标准**: 所有测试通过

## ⚠️ 注意事项

### 1. 服务依赖

某些功能需要其他服务支持：
- **计划分享**: 需要 `relationship-service` (查询群组成员)
- **加密发送**: 需要 `secure-exchange-service` (消息加密)
- **通知**: 需要 `notification-service` (MQ 消息)

如果这些服务未启动，相关测试会优雅地跳过或返回模拟数据。

### 2. 数据库状态

- 测试会创建和删除数据
- 最后会自动清理测试数据
- 建议在测试数据库上运行

### 3. 并发测试

- 当前测试是串行执行的
- 避免多个测试同时运行造成冲突

## 🐛 故障排查

### 测试失败：连接被拒绝

**原因**: 服务未启动  
**解决**: 运行 `npm start` 启动服务

### 测试失败：404 错误

**原因**: API 路由不正确  
**解决**: 检查 `BASE_URL` 配置

### 测试失败：权限错误

**原因**: 权限验证逻辑问题  
**解决**: 检查测试数据中的地址是否正确

### 测试失败：数据库错误

**原因**: 数据库未初始化或连接失败  
**解决**: 运行 `db/init-db.ps1` 初始化数据库

## 📚 相关文档

- [README.md](../README.md) - 服务完整文档
- [QUICKSTART.md](../QUICKSTART.md) - 快速开始指南
- [DESIGN.md](../DESIGN.md) - 系统设计文档

## 🔄 持续集成

将测试集成到 CI/CD 流程：

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm install
      - run: npm run test:all
```

---

**测试版本**: 1.0.0  
**最后更新**: 2025-10-30

