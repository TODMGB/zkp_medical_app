### ERC4337 服务 API 测试（重构后）
### 使用 VS Code REST Client 插件运行

@baseUrl = http://localhost:3000
@userEOA = 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
@userPrivateKey = 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d

### ============================================
### 健康检查
### ============================================
GET {{baseUrl}}/health

### ============================================
### 1. 账户管理 /account
### ============================================

### 1.1 创建社交恢复账户（无守护者）
POST {{baseUrl}}/account
Content-Type: application/json

{
  "ownerAddress": "{{userEOA}}",
  "guardians": [],
  "threshold": 0,
  "salt": 100
}

### 1.2 预计算账户地址
POST {{baseUrl}}/account/address
Content-Type: application/json

{
  "ownerAddress": "{{userEOA}}",
  "guardians": [],
  "threshold": 0,
  "salt": 100
}

### 1.3 查询账户信息
@accountAddress = 0x...

GET {{baseUrl}}/account/{{accountAddress}}

### 1.4 获取账户 Nonce
GET {{baseUrl}}/account/{{accountAddress}}/nonce

### 1.5 构建 InitCode
POST {{baseUrl}}/account/initcode
Content-Type: application/json

{
  "ownerAddress": "{{userEOA}}",
  "guardians": [],
  "threshold": 0,
  "salt": 100
}

### ============================================
### 2. 守护者管理 /guardian
### ============================================

### 2.1 添加守护者
@guardianAddress = 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC

POST {{baseUrl}}/guardian
Content-Type: application/json

{
  "accountAddress": "{{accountAddress}}",
  "ownerPrivateKey": "{{userPrivateKey}}",
  "guardianAddress": "{{guardianAddress}}"
}

### 2.2 查询守护者列表
GET {{baseUrl}}/guardian/{{accountAddress}}

### 2.3 修改阈值
PUT {{baseUrl}}/guardian/threshold
Content-Type: application/json

{
  "accountAddress": "{{accountAddress}}",
  "ownerPrivateKey": "{{userPrivateKey}}",
  "newThreshold": 1
}

### ============================================
### 3. 社交恢复 /recovery
### ============================================

### 3.1 守护者发起恢复
@guardianAccountAddress = 0x...
@guardianPrivateKey = 0x...
@newOwnerAddress = 0x90F79bf6EB2c4f870365E785982E1f101E93b906

POST {{baseUrl}}/recovery/initiate
Content-Type: application/json

{
  "accountAddress": "{{accountAddress}}",
  "guardianAccountAddress": "{{guardianAccountAddress}}",
  "guardianOwnerPrivateKey": "{{guardianPrivateKey}}",
  "newOwnerAddress": "{{newOwnerAddress}}"
}

### 3.2 守护者支持恢复
@guardian2AccountAddress = 0x...
@guardian2PrivateKey = 0x...

POST {{baseUrl}}/recovery/support
Content-Type: application/json

{
  "accountAddress": "{{accountAddress}}",
  "guardianAccountAddress": "{{guardian2AccountAddress}}",
  "guardianOwnerPrivateKey": "{{guardian2PrivateKey}}",
  "newOwnerAddress": "{{newOwnerAddress}}"
}

### 3.3 Owner 取消恢复
POST {{baseUrl}}/recovery/cancel
Content-Type: application/json

{
  "accountAddress": "{{accountAddress}}",
  "ownerPrivateKey": "{{userPrivateKey}}"
}

### 3.4 查询恢复状态
GET {{baseUrl}}/recovery/status/{{accountAddress}}

### ============================================
### 4. Bundler /bundler
### ============================================

### 4.1 提交 UserOperation
POST {{baseUrl}}/bundler/submit
Content-Type: application/json

{
  "sender": "{{accountAddress}}",
  "nonce": 0,
  "initCode": "0x",
  "callData": "0x",
  "callGasLimit": 200000,
  "verificationGasLimit": 500000,
  "preVerificationGas": 100000,
  "maxFeePerGas": "10000000000",
  "maxPriorityFeePerGas": "2000000000",
  "paymasterAndData": "0x375884F74bBc06D1F2C6551456279D328244543f",
  "signature": "0x"
}

### ============================================
### 5. Paymaster /paymaster
### ============================================

### 5.1 Paymaster 充值
POST {{baseUrl}}/paymaster/deposit
Content-Type: application/json

{
  "amount": "1.0"
}

### 5.2 验证 Paymaster
POST {{baseUrl}}/paymaster/validate
Content-Type: application/json

{
  "userOp": {
    "sender": "{{accountAddress}}",
    "nonce": 0,
    "initCode": "0x",
    "callData": "0x",
    "callGasLimit": 200000,
    "verificationGasLimit": 500000,
    "preVerificationGas": 100000,
    "maxFeePerGas": "10000000000",
    "maxPriorityFeePerGas": "2000000000",
    "paymasterAndData": "0x375884F74bBc06D1F2C6551456279D328244543f",
    "signature": "0x"
  }
}

### ============================================
### 完整流程测试
### ============================================

### 步骤 1: 创建守护者账户
# 守护者 1
POST {{baseUrl}}/account
Content-Type: application/json

{
  "ownerAddress": "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
  "guardians": [],
  "threshold": 0,
  "salt": 1001
}

###
# 守护者 2
POST {{baseUrl}}/account
Content-Type: application/json

{
  "ownerAddress": "0x90F79bf6EB2c4f870365E785982E1f101E93b906",
  "guardians": [],
  "threshold": 0,
  "salt": 1002
}

###
# 守护者 3
POST {{baseUrl}}/account
Content-Type: application/json

{
  "ownerAddress": "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65",
  "guardians": [],
  "threshold": 0,
  "salt": 1003
}

### 步骤 2: 创建用户账户
POST {{baseUrl}}/account
Content-Type: application/json

{
  "ownerAddress": "{{userEOA}}",
  "guardians": [],
  "threshold": 0,
  "salt": 2000
}

### 步骤 3: 查看创建的账户
GET {{baseUrl}}/account/{{accountAddress}}

### ============================================
### 说明：
### 1. 将返回的账户地址保存到 @accountAddress 变量
### 2. 使用 POST /guardian 添加守护者
### 3. 使用 PUT /guardian/threshold 设置阈值
### 4. 使用 /recovery/initiate 和 /recovery/support 执行恢复
### ============================================
